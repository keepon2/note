# Linux å†…å­˜ç®¡ç†å­¦ä¹ æ€ç»´å¯¼å›¾

> åŸºäº Linux 6.x å†…æ ¸
> å‚è€ƒä¹¦ç›®ï¼šã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹ã€ã€Šå›¾è§£Linuxå†…æ ¸ åŸºäº6.xã€‹

---

## ğŸ“š ç›®å½•

- [ä¸€ã€åŸºç¡€æ¦‚å¿µå±‚](#ä¸€åŸºç¡€æ¦‚å¿µå±‚)
- [äºŒã€å†…æ ¸å¯åŠ¨ä¸å¼•å¯¼](#äºŒå†…æ ¸å¯åŠ¨ä¸å¼•å¯¼)
- [ä¸‰ã€è¿›ç¨‹åœ°å€ç©ºé—´ç®¡ç†](#ä¸‰è¿›ç¨‹åœ°å€ç©ºé—´ç®¡ç†)
- [å››ã€é¡µé¢ç®¡ç†æœºåˆ¶](#å››é¡µé¢ç®¡ç†æœºåˆ¶)
- [äº”ã€å†…å­˜åˆ†é…ä¸å›æ”¶](#äº”å†…å­˜åˆ†é…ä¸å›æ”¶)
- [å…­ã€äº¤æ¢æœºåˆ¶](#å…­äº¤æ¢æœºåˆ¶)
- [ä¸ƒã€å†…å­˜æ˜ å°„](#ä¸ƒå†…å­˜æ˜ å°„)
- [å…«ã€NUMAæ¶æ„](#å…«numaæ¶æ„)
- [ä¹ã€å†…å­˜è°ƒè¯•ä¸æ€§èƒ½åˆ†æ](#ä¹å†…å­˜è°ƒè¯•ä¸æ€§èƒ½åˆ†æ)
- [åã€å­¦ä¹ è·¯å¾„è§„åˆ’](#åå­¦ä¹ è·¯å¾„è§„åˆ’)

---

## ä¸€ã€åŸºç¡€æ¦‚å¿µå±‚

### 1.1 å†…å­˜ç®¡ç†åŸºæœ¬æ¦‚å¿µ

```mermaid
graph TB
    A[å†…å­˜ç®¡ç†] --> B[è™šæ‹Ÿå†…å­˜]
    A --> C[ç‰©ç†å†…å­˜]
    A --> D[åœ°å€è½¬æ¢]
    
    B --> B1[æŠ½è±¡çš„ã€é€»è¾‘çš„å†…å­˜ç©ºé—´]
    B --> B2[æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹]
    B --> B3[éš”ç¦»ä¸ä¿æŠ¤]
    
    C --> C1[å®é™…çš„ç¡¬ä»¶RAM]
    C --> C2[æ‰€æœ‰è¿›ç¨‹å…±äº«]
    C --> C3[æœ‰é™èµ„æº]
    
    D --> D1[MMUç¡¬ä»¶æ”¯æŒ]
    D --> D2[é¡µè¡¨æœºåˆ¶]
    D --> D3[è™šæ‹Ÿâ†’ç‰©ç†æ˜ å°„]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
    style D fill:#f39c12
```

#### å†…å­˜å•å…ƒå¯¹æ¯”

| å•ä½ | å¤§å° | ç”¨é€” |
|------|------|------|
| ä½ | æœ€å°å•ä½ | æ ‡å¿—ä½ |
| å­—èŠ‚ | 8ä½ | åŸºæœ¬å­˜å‚¨å•ä½ |
| å­— | 32/64ä½ | CPUå¤„ç†å•ä½ |
| é¡µé¢ | 4KB | è™šæ‹Ÿå†…å­˜ç®¡ç†å•ä½ |
| é¡µæ¡† | 4KB | ç‰©ç†å†…å­˜ç®¡ç†å•ä½ |
| æ®µ | å¯å˜ | é€»è¾‘å†…å­˜å•ä½ |

### 1.2 åœ°å€ç±»å‹è¯¦è§£

#### 1.2.1 ä¸‰ç§åœ°å€ç±»å‹å¯¹æ¯”

```mermaid
graph TB
    A[åœ°å€ç±»å‹] --> B[é€»è¾‘åœ°å€ Logical Address]
    A --> C[çº¿æ€§åœ°å€ Linear Address]
    A --> D[ç‰©ç†åœ°å€ Physical Address]
    
    B --> B1["ç¨‹åºä¸­çš„åœ°å€"]
    B --> B2["æ®µé€‰æ‹©ç¬¦:åç§»é‡"]
    B --> B3["éœ€è¦æ®µè½¬æ¢"]
    
    C --> C1["æ®µè½¬æ¢åçš„åœ°å€"]
    C --> C2["ä¹Ÿå°±æ˜¯è™šæ‹Ÿåœ°å€"]
    C --> C3["éœ€è¦é¡µè¡¨è½¬æ¢"]
    
    D --> D1["å®é™…å†…å­˜åœ°å€"]
    D --> D2["ç¡¬ä»¶RAMä¸­çš„ä½ç½®"]
    
    E[x86åœ°å€è½¬æ¢] --> F["é€»è¾‘åœ°å€"]
    F --> G["æ®µæœºåˆ¶ â†’"]
    G --> H["çº¿æ€§åœ°å€"]
    H --> I["é¡µè¡¨æœºåˆ¶ â†’"]
    I --> J["ç‰©ç†åœ°å€"]
    
    style A fill:#e74c3c
    style E fill:#3498db
    style J fill:#2ecc71
```

#### 1.2.2 åœ°å€è½¬æ¢æµç¨‹

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant Seg as æ®µæœºåˆ¶
    participant Page as é¡µè¡¨æœºåˆ¶
    participant MMU as MMU
    participant RAM as ç‰©ç†å†…å­˜
    
    App->>Seg: é€»è¾‘åœ°å€<br/>æ®µé€‰æ‹©ç¬¦:åç§»é‡
    Seg->>Seg: æ®µåŸºå€ + åç§»é‡
    Seg->>Page: çº¿æ€§åœ°å€<br/>(è™šæ‹Ÿåœ°å€)
    Page->>Page: æŸ¥é¡µè¡¨
    Page->>MMU: ç‰©ç†åœ°å€
    MMU->>RAM: è®¿é—®ç‰©ç†å†…å­˜
```

#### 1.2.3 Linuxä¸­çš„åœ°å€å…³ç³»

```mermaid
graph LR
    A[é€»è¾‘åœ°å€] -->|æ®µåŸºå€=0| B[çº¿æ€§åœ°å€]
    B -->|å°±æ˜¯| C[è™šæ‹Ÿåœ°å€]
    C -->|é¡µè¡¨è½¬æ¢| D[ç‰©ç†åœ°å€]
    
    style A fill:#3498db
    style B fill:#e74c3c
    style C fill:#f39c12
    style D fill:#2ecc71
```

**å…³é”®ç†è§£ï¼š**

- **çº¿æ€§åœ°å€ = è™šæ‹Ÿåœ°å€**ï¼ˆåœ¨Linuxä¸­ï¼‰
- **é€»è¾‘åœ°å€ = çº¿æ€§åœ°å€**ï¼ˆå› ä¸ºLinuxæ®µåŸºå€=0ï¼‰
- **ç‰©ç†åœ°å€** = çœŸå®çš„å†…å­˜åœ°å€

#### 1.2.4 ä¸ºä»€ä¹ˆå«"çº¿æ€§åœ°å€"ï¼Ÿ

```mermaid
graph TB
    A[å†å²èƒŒæ™¯] --> B["8086æ—¶ä»£: æ®µåœ°å€:åç§»é‡"]
    A --> C["80286: å¼•å…¥ä¿æŠ¤æ¨¡å¼"]
    A --> D["80386: å¼•å…¥åˆ†é¡µæœºåˆ¶"]
    
    E[å‘½ååŸå› ] --> F["æ®µè½¬æ¢åæ˜¯è¿ç»­çš„"]
    E --> G["æ²¡æœ‰æ®µçš„é‡å "]
    E --> H["åƒä¸€æ¡ç›´çº¿"]
    
    I[ç°ä»£ç®€åŒ–] --> J["Linuxæ®µåŸºå€=0"]
    I --> K["é€»è¾‘åœ°å€ = çº¿æ€§åœ°å€"]
    I --> L["ç»Ÿç§°è™šæ‹Ÿåœ°å€"]
    
    style A fill:#3498db
    style E fill:#e74c3c
    style I fill:#f39c12
```

#### 1.2.5 å®é™…ä¾‹å­ï¼šx86-64 Linuxåœ°å€è½¬æ¢

```mermaid
graph TB
    A[ç¨‹åºä»£ç ] --> B["ptr = 0x7fff12345678"]
    
    B --> C["é€»è¾‘åœ°å€"]
    C --> C1["æ®µé€‰æ‹©ç¬¦: ç”¨æˆ·æ•°æ®æ®µ"]
    C --> C2["åç§»é‡: 0x7fff12345678"]
    
    C --> D["æ®µè½¬æ¢"]
    D --> D1["æ®µåŸºå€: 0x0"]
    D --> D2["æ®µé™é•¿: æœ€å¤§"]
    
    D --> E["çº¿æ€§åœ°å€ = 0x7fff12345678"]
    E --> F["è¿™å°±æ˜¯è™šæ‹Ÿåœ°å€!"]
    
    F --> G["é¡µè¡¨è½¬æ¢"]
    G --> G1["PGD"]
    G --> G2["PUD"]
    G --> G3["PMD"]
    G --> G4["PTE"]
    
    G --> H["ç‰©ç†åœ°å€ = 0x12345000"]
    
    style B fill:#3498db
    style E fill:#e74c3c
    style F fill:#f39c12
    style H fill:#2ecc71
```

#### 1.2.6 Linux 6.xçš„æ®µè®¾ç½®

```c
// Linuxå†…æ ¸ä¸­çš„æ®µæè¿°ç¬¦ï¼ˆç®€åŒ–ï¼‰
// æ‰€æœ‰æ®µçš„åŸºå€éƒ½æ˜¯0ï¼Œé™é•¿éƒ½æ˜¯æœ€å¤§

struct desc_struct {
    unsigned long a;
    unsigned long b;
};

// ç”¨æˆ·ä»£ç æ®µ: åŸºå€=0, é™é•¿=4GB
// ç”¨æˆ·æ•°æ®æ®µ: åŸºå€=0, é™é•¿=4GB  
// å†…æ ¸ä»£ç æ®µ: åŸºå€=0, é™é•¿=4GB
// å†…æ ¸æ•°æ®æ®µ: åŸºå€=0, é™é•¿=4GB
```

```mermaid
graph LR
    A[é€»è¾‘åœ°å€] -->|æ®µåŸºå€=0| B["çº¿æ€§åœ°å€ = é€»è¾‘åœ°å€"]
    B --> C["è™šæ‹Ÿåœ°å€ = çº¿æ€§åœ°å€"]
    
    D[ç»“è®º] --> E["åœ¨Linuxä¸­"]
    D --> F["é€»è¾‘åœ°å€ = çº¿æ€§åœ°å€ = è™šæ‹Ÿåœ°å€"]
    D --> G["åªéœ€è¦é¡µè¡¨è½¬æ¢"]
    
    style A fill:#3498db
    style B fill:#e74c3c
    style C fill:#f39c12
    style D fill:#2ecc71
```

#### 1.2.7 åœ°å€ç±»å‹æ€»ç»“è¡¨

| åœ°å€ç±»å‹ | å®šä¹‰ | ç‰¹ç‚¹ | Linuxä¸­çš„å¤„ç† |
|----------|------|------|---------------|
| **ç‰©ç†åœ°å€** | å®é™…å†…å­˜åœ°å€ | ç¡¬ä»¶RAMä¸­çš„ä½ç½® | CPUç›´æ¥è®¿é—® |
| **é€»è¾‘åœ°å€** | ç¨‹åºä¸­çš„åœ°å€ | æ®µé€‰æ‹©ç¬¦:åç§»é‡ | æ®µåŸºå€=0ï¼Œç­‰äºè™šæ‹Ÿåœ°å€ |
| **çº¿æ€§åœ°å€** | æ®µè½¬æ¢åçš„åœ°å€ | x86æœ¯è¯­ | ç­‰äºè™šæ‹Ÿåœ°å€ |
| **è™šæ‹Ÿåœ°å€** | è¿›ç¨‹çœ‹åˆ°çš„åœ°å€ | Linuxæœ¯è¯­ | é€šè¿‡é¡µè¡¨è½¬æ¢ä¸ºç‰©ç†åœ°å€ |

**ç®€å•è®°å¿†å…¬å¼ï¼ˆLinuxä¸­ï¼‰ï¼š**

```
é€»è¾‘åœ°å€ = çº¿æ€§åœ°å€ = è™šæ‹Ÿåœ°å€ â†’ é¡µè¡¨è½¬æ¢ â†’ ç‰©ç†åœ°å€
```

#### 1.2.8 å®æˆ˜ï¼šæŸ¥çœ‹è¿›ç¨‹åœ°å€æ˜ å°„

```bash
# æŸ¥çœ‹è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆçº¿æ€§åœ°å€ï¼‰
cat /proc/self/maps

# è¾“å‡ºç¤ºä¾‹ï¼š
# 00400000-00452000 r-xp 00000000 08:01 123456 /bin/ls
# 00652000-00653000 r--p 00012000 08:01 123456 /bin/ls
# 00653000-00654000 rw-p 00013000 08:01 123456 /bin/ls
# 7ff000000000-7ff000021000 rw-p 00000000 00:00 0          [heap]
# 7ffff7dda000-7ffff7dfd000 r-xp 00000000 08:01 789012 /lib/x86_64-linux-gnu/libc-2.31.so
```

è¿™äº›åœ°å€éƒ½æ˜¯**çº¿æ€§åœ°å€**ï¼ˆä¹Ÿå°±æ˜¯è™šæ‹Ÿåœ°å€ï¼‰ï¼Œéœ€è¦é€šè¿‡é¡µè¡¨è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚

### 1.3 æ®µæœºåˆ¶è¯¦è§£

#### 1.3.1 ä»€ä¹ˆæ˜¯æ®µï¼ˆSegmentï¼‰ï¼Ÿ

```mermaid
graph TB
    A[æ®µ Segment] --> B[å†…å­˜çš„é€»è¾‘åˆ’åˆ†]
    A --> C[åŒ…å«ç‰¹å®šç±»å‹çš„æ•°æ®]
    A --> D[å…·æœ‰è®¿é—®æƒé™]
    
    B --> B1["ä»£ç æ®µ: ç¨‹åºä»£ç "]
    B --> B2["æ•°æ®æ®µ: å…¨å±€å˜é‡"]
    B --> B3["æ ˆæ®µ: å±€éƒ¨å˜é‡"]
    B --> B4["å †æ®µ: åŠ¨æ€å†…å­˜"]
    
    C --> C1["èµ·å§‹åœ°å€: æ®µåŸºå€"]
    C --> C2["é•¿åº¦: æ®µé™é•¿"]
    C --> C3["å±æ€§: è®¿é—®æƒé™"]
    
    D --> D1["å¯è¯»/å¯å†™/å¯æ‰§è¡Œ"]
    D --> D2["ç‰¹æƒçº§: Ring 0-3"]
    D --> D3["ä¿æŠ¤æœºåˆ¶"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#f39c12
```

**ç®€å•ç†è§£ï¼š**

æ®µå°±åƒæ˜¯æŠŠå†…å­˜åˆ†æˆä¸åŒçš„"æˆ¿é—´"ï¼Œæ¯ä¸ªæˆ¿é—´æœ‰ç‰¹å®šçš„ç”¨é€”ï¼š
- **ä»£ç æ®µ**ï¼šå­˜æ”¾ç¨‹åºæŒ‡ä»¤ï¼ˆåªè¯»ã€å¯æ‰§è¡Œï¼‰
- **æ•°æ®æ®µ**ï¼šå­˜æ”¾å…¨å±€å˜é‡ï¼ˆå¯è¯»å†™ï¼‰
- **æ ˆæ®µ**ï¼šå­˜æ”¾å‡½æ•°è°ƒç”¨ä¿¡æ¯ï¼ˆå¯è¯»å†™ï¼‰
- **å †æ®µ**ï¼šå­˜æ”¾åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼ˆå¯è¯»å†™ï¼‰

#### 1.3.2 æ®µçš„å†å²èƒŒæ™¯

```mermaid
graph LR
    A[8086 1978] --> B[80286 1982]
    B --> C[80386 1985]
    C --> D[ç°ä»£ 64ä½]
    
    A --> A1[å®æ¨¡å¼]
    A1 --> A2[20ä½åœ°å€çº¿ æœ€å¤§1MB]
    A1 --> A3[æ®µåœ°å€:åç§»é‡]
    
    B --> B1[ä¿æŠ¤æ¨¡å¼]
    B1 --> B2[24ä½åœ°å€çº¿ 16MB]
    B1 --> B3[å¼•å…¥æ®µæè¿°ç¬¦]
    
    C --> C1[åˆ†é¡µæœºåˆ¶]
    C1 --> C2[32ä½åœ°å€çº¿ 4GB]
    C1 --> C3[æ®µ+é¡µä¸¤çº§è½¬æ¢]
    
    D --> D1[ç®€åŒ–æ®µæœºåˆ¶]
    D1 --> D2[Linuxæ®µåŸºå€=0]
    D1 --> D3[ä¸»è¦ä½¿ç”¨åˆ†é¡µ]
    
    style A fill:#3498db
    style B fill:#3498db
    style C fill:#3498db
    style D fill:#2ecc71
```

#### 1.3.3 æ®µçš„ç»„æˆç»“æ„

```mermaid
graph TB
    A[æ®µæè¿°ç¬¦] --> B[æ®µåŸºå€ Base Address]
    A --> C[æ®µé™é•¿ Limit]
    A --> D[è®¿é—®æƒé™ Access Rights]
    A --> E[ç‰¹æƒçº§ DPL]
    
    B --> B1["æ®µçš„èµ·å§‹åœ°å€"]
    B --> B2["32ä½æˆ–64ä½"]
    
    C --> C1["æ®µçš„é•¿åº¦"]
    C --> C2["ä»¥å­—èŠ‚æˆ–é¡µä¸ºå•ä½"]
    
    D --> D1["å¯è¯» Readable"]
    D --> D2["å¯å†™ Writable"]
    D --> D3["å¯æ‰§è¡Œ Executable"]
    
    E --> E1["æè¿°ç¬¦ç‰¹æƒçº§"]
    E --> E2["0-3: Ring 0-3"]
    E --> E3["å†…æ ¸æ®µ: Ring 0"]
    E --> E4["ç”¨æˆ·æ®µ: Ring 3"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
```

#### 1.3.4 é€»è¾‘åœ°å€çš„ç»„æˆ

```mermaid
graph LR
    A[é€»è¾‘åœ°å€] --> B[æ®µé€‰æ‹©ç¬¦ Selector]
    A --> C[åç§»é‡ Offset]
    
    B --> B1["16ä½"]
    B --> B2["é€‰æ‹©GDTä¸­çš„æ®µæè¿°ç¬¦"]
    B --> B3["ç´¢å¼•åˆ°GDTè¡¨"]
    
    C --> C1["32ä½æˆ–64ä½"]
    C --> C2["æ®µå†…çš„åç§»"]
    C --> C3["æœ€å¤§4GBæˆ–64TB"]
    
    D[åœ°å€è®¡ç®—] --> E["çº¿æ€§åœ°å€ = æ®µåŸºå€ + åç§»é‡"]
    
    style A fill:#e74c3c
    style D fill:#f39c12
```

**å®é™…ä¾‹å­ï¼š**

```
é€»è¾‘åœ°å€: 0x0008:0x12345678
         â†“       â†“
      æ®µé€‰æ‹©ç¬¦  åç§»é‡
         â†“
      é€‰æ‹©GDTç¬¬1ä¸ªæ®µ
         â†“
      æ®µåŸºå€ = 0x00000000
         â†“
      çº¿æ€§åœ°å€ = 0x00000000 + 0x12345678
                = 0x12345678
```

#### 1.3.5 æ®µé€‰æ‹©ç¬¦è¯¦è§£

```mermaid
graph TB
    A[æ®µé€‰æ‹©ç¬¦ 16ä½] --> B[ç´¢å¼• Index 13ä½]
    A --> C[è¡¨æŒ‡ç¤ºç¬¦ TI 1ä½]
    A --> D[è¯·æ±‚ç‰¹æƒçº§ RPL 2ä½]
    
    B --> B1["0-8191"]
    B --> B2["é€‰æ‹©GDTä¸­çš„æ®µæè¿°ç¬¦"]
    
    C --> C1["0: GDT (å…¨å±€æè¿°ç¬¦è¡¨)"]
    C --> C2["1: LDT (å±€éƒ¨æè¿°ç¬¦è¡¨)"]
    
    D --> D1["0-3"]
    D --> D2["è¯·æ±‚çš„ç‰¹æƒçº§"]
    D --> D3["0: å†…æ ¸æ€ Ring 0"]
    D --> D4["3: ç”¨æˆ·æ€ Ring 3"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#f39c12
    style D fill:#2ecc71
```

#### 1.3.6 GDTï¼ˆå…¨å±€æè¿°ç¬¦è¡¨ï¼‰

```mermaid
graph TB
    A[GDT å…¨å±€æè¿°ç¬¦è¡¨] --> B[æ®µæè¿°ç¬¦æ•°ç»„]
    A --> C[ç³»ç»Ÿå…¨å±€å…±äº«]
    A --> D[ç”±å†…æ ¸ç®¡ç†]
    
    B --> B1["æ®µæè¿°ç¬¦ 0"]
    B --> B2["æ®µæè¿°ç¬¦ 1: ä»£ç æ®µ"]
    B --> B3["æ®µæè¿°ç¬¦ 2: æ•°æ®æ®µ"]
    B --> B4["æ®µæè¿°ç¬¦ 3: æ ˆæ®µ"]
    B --> B5["..."]
    
    E[æ¯ä¸ªæ®µæè¿°ç¬¦] --> F["æ®µåŸºå€ 32/64ä½"]
    E --> G["æ®µé™é•¿ 20ä½"]
    E --> H["è®¿é—®æƒé™ 8ä½"]
    E --> I["ç‰¹æƒçº§ 2ä½"]
    
    style A fill:#e74c3c
    style E fill:#3498db
```

#### 1.3.7 Linux 6.xä¸­çš„æ®µè®¾ç½®

```mermaid
graph TB
    A[Linuxæ®µç­–ç•¥] --> B[ç®€åŒ–æ®µæœºåˆ¶]
    A --> C[æ®µåŸºå€éƒ½ä¸º0]
    A --> D[ä¸»è¦ä½¿ç”¨åˆ†é¡µ]
    
    B --> B1["å‡å°‘æ®µçš„å¼€é”€"]
    B --> B2["ç®€åŒ–åœ°å€è½¬æ¢"]
    B --> B3["æé«˜æ€§èƒ½"]
    
    C --> C1["ç”¨æˆ·ä»£ç æ®µ: åŸºå€=0"]
    C --> C2["ç”¨æˆ·æ•°æ®æ®µ: åŸºå€=0"]
    C --> C3["å†…æ ¸ä»£ç æ®µ: åŸºå€=0"]
    C --> C4["å†…æ ¸æ•°æ®æ®µ: åŸºå€=0"]
    
    E[ç»“æœ] --> F["é€»è¾‘åœ°å€ = çº¿æ€§åœ°å€"]
    E --> G["æ®µæœºåˆ¶å‡ ä¹é€æ˜"]
    E --> H["é¡µè¡¨æ˜¯ä¸»è¦æœºåˆ¶"]
    
    style A fill:#e74c3c
    style E fill:#2ecc71
```

**Linuxå†…æ ¸ä»£ç ï¼š**

```c
// arch/x86/include/asm/segment.h

// ç”¨æˆ·ä»£ç æ®µ
#define __USER_CS  (GDT_ENTRY_DEFAULT_USER_CS * 8 + 3)

// ç”¨æˆ·æ•°æ®æ®µ
#define __USER_DS  (GDT_ENTRY_DEFAULT_USER_DS * 8 + 3)

// å†…æ ¸ä»£ç æ®µ
#define __KERNEL_CS (GDT_ENTRY_KERNEL_CS * 8)

// å†…æ ¸æ•°æ®æ®µ
#define __KERNEL_DS (GDT_ENTRY_KERNEL_DS * 8)
```

#### 1.3.8 æ®µ vs é¡µçš„åŒºåˆ«

```mermaid
graph TB
    A[æ®µ vs é¡µ] --> B[æ®µ Segment]
    A --> C[é¡µ Page]
    
    B --> B1["é€»è¾‘å•ä½"]
    B --> B2["å¯å˜å¤§å°"]
    B --> B3["åŒ…å«ç‰¹å®šç±»å‹æ•°æ®"]
    B --> B4["ä¿æŠ¤æœºåˆ¶"]
    B --> B5["å†å²é—ç•™"]
    
    C --> C1["ç‰©ç†å•ä½"]
    C --> C2["å›ºå®šå¤§å° 4KB"]
    C --> C3["å†…å­˜ç®¡ç†å•ä½"]
    C --> C4["è™šæ‹ŸåŒ–æ”¯æŒ"]
    C --> C5["ç°ä»£ä¸»æµ"]
    
    D[ä½¿ç”¨åœºæ™¯] --> E["æ®µ: ä¿æŠ¤ä¸åŒç±»å‹çš„æ•°æ®"]
    D --> F["é¡µ: è™šæ‹Ÿå†…å­˜ç®¡ç†"]
    
    style A fill:#e74c3c
    style D fill:#f39c12
```

| ç‰¹æ€§ | æ®µ | é¡µ |
|------|-----|-----|
| **ç›®çš„** | é€»è¾‘åˆ’åˆ†ã€ä¿æŠ¤ | ç‰©ç†å†…å­˜ç®¡ç† |
| **å¤§å°** | å¯å˜ | å›ºå®šï¼ˆ4KBï¼‰ |
| **å¯è§æ€§** | ç¨‹åºå¯è§ | å¯¹ç¨‹åºé€æ˜ |
| **è½¬æ¢** | é€»è¾‘â†’çº¿æ€§ | çº¿æ€§â†’ç‰©ç† |
| **ç°ä»£ä½¿ç”¨** | ç®€åŒ–ï¼ˆLinuxåŸºå€=0ï¼‰ | å¹¿æ³›ä½¿ç”¨ |

#### 1.3.9 æ®µä¿æŠ¤æœºåˆ¶

```mermaid
graph TB
    A[æ®µä¿æŠ¤] --> B[ç‰¹æƒçº§æ£€æŸ¥]
    A --> C[æƒé™æ£€æŸ¥]
    A --> D[é™é•¿æ£€æŸ¥]
    
    B --> B1["CPL vs DPL"]
    B --> B2["ç”¨æˆ·æ€ä¸èƒ½è®¿é—®å†…æ ¸æ®µ"]
    B --> B3["Ring 3 < Ring 0"]
    
    C --> C1["è¯»/å†™/æ‰§è¡Œæƒé™"]
    C --> C2["åªè¯»æ®µä¸èƒ½å†™å…¥"]
    C --> C3["ä»£ç æ®µä¸èƒ½æ‰§è¡Œæ•°æ®"]
    
    D --> D1["åç§»é‡ < æ®µé™é•¿"]
    D --> D2["é˜²æ­¢æ®µè¶Šç•Œ"]
    D --> D3["è§¦å‘å¼‚å¸¸"]
    
    E[ä¿æŠ¤æ•ˆæœ] --> F["è¿›ç¨‹éš”ç¦»"]
    E --> G["å†…æ ¸ä¿æŠ¤"]
    E --> H["é˜²æ­¢éæ³•è®¿é—®"]
    
    style A fill:#e74c3c
    style E fill:#2ecc71
```

#### 1.3.10 å®æˆ˜ï¼šæŸ¥çœ‹æ®µå¯„å­˜å™¨

```bash
# åœ¨Linuxä¸­æŸ¥çœ‹æ®µå¯„å­˜å™¨
cat /proc/self/status | grep -i seg

# æŸ¥çœ‹è¿›ç¨‹çš„æ®µä¿¡æ¯
cat /proc/self/maps

# è¾“å‡ºç¤ºä¾‹ï¼š
# 00400000-00452000 r-xp 00000000 08:01 123456 /bin/ls
# 00652000-00653000 r--p 00012000 08:01 123456 /bin/ls
# 00653000-00654000 rw-p 00013000 08:01 123456 /bin/ls
```

è¿™äº›å°±æ˜¯å„ä¸ªVMAï¼ˆè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼‰ï¼Œåœ¨Linuxä¸­ï¼Œæ®µçš„æ¦‚å¿µè¢«å¤§å¤§ç®€åŒ–äº†ã€‚

#### 1.3.11 æ®µæœºåˆ¶æ€»ç»“

```mermaid
mindmap
  root((æ®µæœºåˆ¶))
    å®šä¹‰
      é€»è¾‘å†…å­˜å•å…ƒ
      åŒ…å«ç‰¹å®šæ•°æ®
      å…·æœ‰è®¿é—®æƒé™
    ç»„æˆ
      æ®µåŸºå€
      æ®µé™é•¿
      è®¿é—®æƒé™
      ç‰¹æƒçº§
    åœ°å€è½¬æ¢
      é€»è¾‘åœ°å€
      æ®µé€‰æ‹©ç¬¦ + åç§»é‡
      çº¿æ€§åœ°å€ = åŸºå€ + åç§»
    Linux 6.x
      æ®µåŸºå€ = 0
      æ®µé™é•¿ = æœ€å¤§
      ç®€åŒ–æœºåˆ¶
      ä¸»è¦ä½¿ç”¨åˆ†é¡µ
    ä¿æŠ¤
      ç‰¹æƒçº§æ£€æŸ¥
      æƒé™æ£€æŸ¥
      é™é•¿æ£€æŸ¥
      è¿›ç¨‹éš”ç¦»
```

**å…³é”®è¦ç‚¹ï¼š**

1. **æ®µæ˜¯é€»è¾‘åˆ’åˆ†**ï¼šå°†å†…å­˜æŒ‰åŠŸèƒ½åˆ†æˆä¸åŒçš„åŒºåŸŸ
2. **æ®µä¿æŠ¤**ï¼šé€šè¿‡ç‰¹æƒçº§å’Œæƒé™å®ç°ä¿æŠ¤
3. **Linuxç®€åŒ–**ï¼šæ®µåŸºå€=0ï¼Œæ®µæœºåˆ¶å‡ ä¹é€æ˜
4. **ç°ä»£ç³»ç»Ÿ**ï¼šä¸»è¦ä½¿ç”¨åˆ†é¡µï¼Œæ®µæˆä¸ºå†å²é—ç•™

### 1.4 Linuxå†…å­˜æ¶æ„ (6.xå†…æ ¸)

```mermaid
graph TB
    A[64ä½ç³»ç»Ÿåœ°å€ç©ºé—´] --> B[ç”¨æˆ·ç©ºé—´]
    A --> C[å†…æ ¸ç©ºé—´]
    
    B --> B1["0x0000000000000000 - 0x00007fffffffffff"]
    B --> B2["128TB"]
    B --> B3["Ring 3 (ç”¨æˆ·æ€)"]
    
    C --> C1["0xffff800000000000 - 0xffffffffffffffff"]
    C --> C2["128TB"]
    C --> C3["Ring 0 (å†…æ ¸æ€)"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
```

#### å†…å­˜åŒºåŸŸåˆ’åˆ†

```mermaid
graph TB
    A[ç‰©ç†å†…å­˜åŒºåŸŸ] --> B[ZONE_DMA]
    A --> C[ZONE_DMA32]
    A --> D[ZONE_NORMAL]
    A --> E[ZONE_MOVABLE]
    A --> F[ZONE_DEVICE]
    
    B --> B1["ISAè®¾å¤‡DMA"]
    B --> B2["å‰16MB"]
    
    C --> C1["32ä½å¯å¯»å€DMA"]
    C --> C2["32ä½è®¾å¤‡"]
    
    D --> D1["å¸¸è§„å¯ç›´æ¥æ˜ å°„"]
    D --> D2["å¤§éƒ¨åˆ†å†…å­˜"]
    
    E --> E1["å¯ç§»åŠ¨å†…å­˜"]
    E --> E2["çƒ­æ’æ‹”/ç¢ç‰‡æ•´ç†"]
    
    F --> F1["è®¾å¤‡å†…å­˜"]
    F --> F2["æŒä¹…å†…å­˜/GPU"]
    
    style A fill:#e74c3c
    style D fill:#2ecc71
    style E fill:#f39c12
```

### 1.4 å†…å­˜ç®¡ç†æ ¸å¿ƒæ•°æ®ç»“æ„

```mermaid
classDiagram
    class task_struct {
        +struct mm_struct *mm
        +struct mm_struct *active_mm
    }
    
    class mm_struct {
        +pgd_t *pgd
        +struct vm_area_struct *mmap
        +struct rb_root mm_rbroot
        +unsigned long total_vm
        +unsigned long locked_vm
        +unsigned long start_code
        +unsigned long end_code
        +unsigned long start_data
        +unsigned long end_data
        +unsigned long start_brk
        +unsigned long brk
        +unsigned long start_stack
    }
    
    class vm_area_struct {
        +unsigned long vm_start
        +unsigned long vm_end
        +struct mm_struct *vm_mm
        +pgprot_t vm_page_prot
        +unsigned long vm_flags
        +struct rb_node vm_rb
        +struct list_head vm_list
        +const struct vm_operations_struct *vm_ops
        +struct file *vm_file
        +unsigned long vm_pgoff
    }
    
    class zone {
        +struct free_area free_area[]
        +struct list_head active_list
        +struct list_head inactive_list
        +unsigned long vm_stat[]
    }
    
    class page {
        +unsigned long flags
        +atomic_t _count
        +struct address_space *mapping
        +unsigned long index
        +void *virtual
    }
    
    task_struct "1" --> "1" mm_struct
    mm_struct "1" --> "*" vm_area_struct
    zone "1" --> "*" page
```

---

## ä¸‰ã€è¿›ç¨‹åœ°å€ç©ºé—´ç®¡ç†

### 3.1 è¿›ç¨‹å†…å­˜å¸ƒå±€ (64ä½Linux 6.x)

```mermaid
graph TB
    A[64ä½åœ°å€ç©ºé—´] --> B[å†…æ ¸ç©ºé—´ 128TB]
    A --> C[ç”¨æˆ·ç©ºé—´ 128TB]
    
    C --> D[é«˜åœ°å€]
    D --> E[æ ˆåŒº Stack]
    E --> F[ç©ºé—²åŒºåŸŸ]
    F --> G[å†…å­˜æ˜ å°„æ®µ mmap]
    G --> H[å †åŒº Heap]
    H --> I[BSSæ®µ]
    I --> J[æ•°æ®æ®µ Data]
    J --> K[ä»£ç æ®µ Text]
    K --> L[ä½åœ°å€]
    
    style A fill:#e74c3c
    style B fill:#f39c12
    style C fill:#3498db
```

#### å„æ®µè¯¦ç»†è¯´æ˜

| æ®µå | åœ°å€æ–¹å‘ | å†…å®¹ | ç‰¹ç‚¹ |
|------|----------|------|------|
| ä»£ç æ®µ | ä½â†’é«˜ | ç¨‹åºä»£ç  | åªè¯»ã€å¯å…±äº« |
| æ•°æ®æ®µ | ä½â†’é«˜ | å·²åˆå§‹åŒ–å…¨å±€/é™æ€å˜é‡ | å¯è¯»å†™ |
| BSSæ®µ | ä½â†’é«˜ | æœªåˆå§‹åŒ–å…¨å±€/é™æ€å˜é‡ | ç¨‹åºåŠ è½½æ—¶æ¸…é›¶ |
| å †åŒº | ä½â†’é«˜ | åŠ¨æ€å†…å­˜åˆ†é… | å‘ä¸Šå¢é•¿ |
| å†…å­˜æ˜ å°„æ®µ | ä½â†’é«˜ | mmapåŒºåŸŸ | å…±äº«åº“ã€æ–‡ä»¶æ˜ å°„ |
| æ ˆåŒº | é«˜â†’ä½ | å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•° | å‘ä¸‹å¢é•¿ |

### 3.2 VMAç»„ç»‡ç»“æ„

```mermaid
graph TB
    A[mm_struct] --> B[é“¾è¡¨ç»„ç»‡]
    A --> C[çº¢é»‘æ ‘ç»„ç»‡]
    
    B --> D[VMA1] --> E[VMA2] --> F[VMA3] --> G[VMA4]
    
    C --> H[VMA3]
    H --> I[VMA2]
    H --> J[VMA4]
    I --> K[VMA1]
    
    L[æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦] --> M["é“¾è¡¨: O(n)"]
    L --> N["çº¢é»‘æ ‘: O(log n)"]
    
    style A fill:#e74c3c
    style C fill:#2ecc71
```

---

## äºŒã€å†…æ ¸å¯åŠ¨ä¸å¼•å¯¼

### 2.1 Memblockå†…å­˜ç®¡ç†å™¨

#### 2.1.1 ä»€ä¹ˆæ˜¯Memblockï¼Ÿ

```mermaid
graph TB
    A[Memblock] --> B[å†…æ ¸æ—©æœŸå†…å­˜ç®¡ç†å™¨]
    A --> C[Bootmemçš„æ›¿ä»£å“]
    A --> D[ä¸´æ—¶æ€§å†…å­˜ç®¡ç†]
    
    B --> B1["å†…æ ¸å¯åŠ¨é˜¶æ®µä½¿ç”¨"]
    B --> B2["ä¼™ä¼´ç³»ç»Ÿåˆå§‹åŒ–å‰"]
    B --> B3["ç®€å•é«˜æ•ˆ"]
    
    C --> C1["Linux 2.6å¼•å…¥"]
    C --> C2["æ›¿ä»£Bootmem"]
    C --> C3["æ”¯æŒæ›´å¤šåŠŸèƒ½"]
    
    D --> D1["ä»…åœ¨å¯åŠ¨æ—¶ä½¿ç”¨"]
    D --> D2["å¯åŠ¨åç§»äº¤ç»™ä¼™ä¼´ç³»ç»Ÿ"]
    D --> D3["ä¸ç”¨äºè¿è¡Œæ—¶åˆ†é…"]
    
    E[ä½¿ç”¨é˜¶æ®µ] --> F["å†…æ ¸åˆå§‹åŒ–"]
    E --> G["è®¾å¤‡åˆå§‹åŒ–"]
    E --> H["ä¼™ä¼´ç³»ç»Ÿå»ºç«‹"]
    
    I[ç‰¹ç‚¹] --> J["ç®¡ç†ç‰©ç†å†…å­˜"]
    I --> K["æ”¯æŒå†…å­˜é¢„ç•™"]
    I --> L["æ”¯æŒå†…å­˜é•œåƒ"]
    
    style A fill:#e74c3c
    style E fill:#3498db
    style I fill:#2ecc71
```

**Memblock**æ˜¯Linuxå†…æ ¸å¯åŠ¨é˜¶æ®µçš„ä¸´æ—¶å†…å­˜ç®¡ç†å™¨ï¼Œç”¨äºåœ¨ä¼™ä¼´ç³»ç»Ÿåˆå§‹åŒ–ä¹‹å‰ç®¡ç†ç‰©ç†å†…å­˜ã€‚

#### 2.1.2 Memblockçš„ä½œç”¨

```mermaid
graph TB
    A[Memblockä½œç”¨] --> B[å†…å­˜åˆ†é…]
    A --> C[å†…å­˜é¢„ç•™]
    A --> D[å†…å­˜é•œåƒ]
    A --> E[å†…å­˜ä¿¡æ¯ç®¡ç†]
    
    B --> B1["åˆ†é…ç‰©ç†å†…å­˜"]
    B --> B2["ç”¨äºå†…æ ¸æ•°æ®ç»“æ„"]
    B --> B3["ç”¨äºè®¾å¤‡åˆå§‹åŒ–"]
    
    C --> C1["é¢„ç•™ç‰¹å®šå†…å­˜åŒºåŸŸ"]
    C --> C2["ä¿ç•™ç»™è®¾å¤‡ä½¿ç”¨"]
    C --> C3["ä¿ç•™ç»™å†…æ ¸ä½¿ç”¨"]
    
    D --> D1["æ”¯æŒå†…å­˜é•œåƒ"]
    D --> D2["RASç‰¹æ€§"]
    D --> D3["å†…å­˜å†—ä½™"]
    
    E --> E1["è®°å½•å†…å­˜å¸ƒå±€"]
    E --> E2["ä¼ é€’ç»™ä¼™ä¼´ç³»ç»Ÿ"]
    E --> E3["æ”¯æŒå†…å­˜æ¢æµ‹"]
    
    F[ç”Ÿå‘½å‘¨æœŸ] --> G["å†…æ ¸å¯åŠ¨"]
    F --> H["ä¼™ä¼´ç³»ç»Ÿåˆå§‹åŒ–"]
    F --> I["Memblocké‡Šæ”¾"]
    
    style A fill:#e74c3c
    style F fill:#3498db
```

#### 2.1.3 Memblockç®¡ç†çš„å†…å­˜ç±»å‹

```mermaid
graph TB
    A[Memblockå†…å­˜ç±»å‹] --> B[Memory å¯ç”¨å†…å­˜]
    A --> C[Reserved ä¿ç•™å†…å­˜]
    A --> D[Nomad æ— å½’å±å†…å­˜]
    
    B --> B1["å¯åˆ†é…çš„ç‰©ç†å†…å­˜"]
    B --> B2["RAMåŒºåŸŸ"]
    B --> B3["å¯ä»¥è¢«åˆ†é…ä½¿ç”¨"]
    
    C --> C1["è¢«é¢„ç•™çš„å†…å­˜"]
    C --> C2["ä¸èƒ½è¢«åˆ†é…"]
    C --> C3["æœ‰ç‰¹å®šç”¨é€”"]
    
    D --> D1["æœªçŸ¥çš„å†…å­˜ç±»å‹"]
    D --> D2["BIOSä¿ç•™"]
    D --> D3["ACPIæ•°æ®"]
    
    E[Reservedç±»å‹ç»†åˆ†] --> F["å†…æ ¸ä»£ç æ®µ"]
    E --> G["å†…æ ¸æ•°æ®æ®µ"]
    E --> H["è®¾å¤‡å¯„å­˜å™¨"]
    E --> I["BIOSåŒºåŸŸ"]
    E --> J["ACPIè¡¨"]
    E --> K["å†…æ ¸å‚æ•°"]
    
    style A fill:#e74c3c
    style E fill:#f39c12
```

**é‡è¦ï¼šMemblockç®¡ç†çš„åŒºåŸŸä¸éƒ½æ˜¯Holeï¼**

**å†…å­˜ç±»å‹è¯´æ˜ï¼š**

| ç±»å‹ | è¯´æ˜ | æ˜¯å¦Hole | ç”¨é€” |
|------|------|----------|------|
| **Memory** | å¯ç”¨å†…å­˜ | âŒ ä¸æ˜¯ | å¯ä»¥è¢«åˆ†é…ä½¿ç”¨ |
| **Reserved** | ä¿ç•™å†…å­˜ | âŒ ä¸æ˜¯ | æœ‰ç‰¹å®šç”¨é€”ï¼Œä¸èƒ½åˆ†é… |
| **Nomad** | æ— å½’å±å†…å­˜ | âš ï¸ å¯èƒ½æ˜¯ | BIOS/ACPIä¿ç•™åŒºåŸŸ |

**Holeï¼ˆç©ºæ´ï¼‰**ï¼šæŒ‡ç‰©ç†å†…å­˜ä¸­ä¸å­˜åœ¨çš„åœ°å€ç©ºé—´ï¼Œé€šå¸¸æ˜¯å› ä¸ºï¼š
- å†…å­˜åœ°å€ä¸è¿ç»­
- æŸäº›åœ°å€èŒƒå›´æ²¡æœ‰ç‰©ç†RAM
- ç¡¬ä»¶ä¿ç•™çš„åœ°å€ç©ºé—´

#### 2.1.4 Memblockæ•°æ®ç»“æ„

```c
// Memblockæ ¸å¿ƒæ•°æ®ç»“æ„
struct memblock {
    bool bottom_up;  // åˆ†é…æ–¹å‘ï¼šä»ä½åœ°å€åˆ°é«˜åœ°å€
    phys_addr_t current_limit;  // å½“å‰å†…å­˜é™åˆ¶
    
    struct memblock_type memory;  // å¯ç”¨å†…å­˜åŒºåŸŸ
    struct memblock_type reserved;  // ä¿ç•™å†…å­˜åŒºåŸŸ
};

struct memblock_type {
    unsigned long cnt;  // åŒºåŸŸæ•°é‡
    unsigned long max;  // æœ€å¤§åŒºåŸŸæ•°
    phys_addr_t total_size;  // æ€»å¤§å°
    struct memblock_region *regions;  // åŒºåŸŸæ•°ç»„
};

struct memblock_region {
    phys_addr_t base;  // èµ·å§‹ç‰©ç†åœ°å€
    phys_addr_t size;  // å¤§å°
    unsigned long flags;  // æ ‡å¿—ä½
};
```

```mermaid
classDiagram
    class memblock {
        +bool bottom_up
        +phys_addr_t current_limit
        +struct memblock_type memory
        +struct memblock_type reserved
    }
    
    class memblock_type {
        +unsigned long cnt
        +unsigned long max
        +phys_addr_t total_size
        +struct memblock_region *regions
    }
    
    class memblock_region {
        +phys_addr_t base
        +phys_addr_t size
        +unsigned long flags
    }
    
    memblock "1" --> "1" memblock_type : memory
    memblock "1" --> "1" memblock_type : reserved
    memblock_type "1" --> "*" memblock_region : regions
```

#### 2.1.5 Memblockå†…å­˜å¸ƒå±€ç¤ºä¾‹

```mermaid
graph TB
    A["ç‰©ç†å†…å­˜ (8GB)"] --> B["0x00000000 - 0x000FFFFF"]
    A --> C["0x00100000 - 0x00FFFFFF"]
    A --> D["0x01000000 - 0x7FFFFFFF"]
    A --> E["0x80000000 - 0xFFFFFFFF"]
    A --> F["0x100000000 - 0x1FFFFFFFF"]
    
    B --> B1["BIOS/ä¿ç•™åŒºåŸŸ"]
    B --> B2["Reserved"]
    
    C --> C1["å†…æ ¸ä»£ç æ®µ"]
    C --> C2["Reserved"]
    
    D --> D1["å¯ç”¨å†…å­˜"]
    D --> D2["Memory"]
    
    E --> E3["è®¾å¤‡å¯„å­˜å™¨"]
    E --> E4["Reserved"]
    
    F --> F5["å¯ç”¨å†…å­˜"]
    F --> F6["Memory"]
    
    G[Memblockç®¡ç†] --> H["Memory: 0x01000000-0x00FFFFFF"]
    G --> I["Memory: 0x100000000-0x1FFFFFFFF"]
    G --> J["Reserved: 0x00000000-0x00FFFFFF"]
    G --> K["Reserved: 0x80000000-0xFFFFFFFF"]
    
    style A fill:#e74c3c
    style D fill:#2ecc71
    style F fill:#2ecc71
    style G fill:#3498db
```

**ç¤ºä¾‹è¯´æ˜ï¼š**

- **MemoryåŒºåŸŸ**ï¼š0x01000000-0x00FFFFFF å’Œ 0x100000000-0x1FFFFFFFF
- **ReservedåŒºåŸŸ**ï¼š0x00000000-0x00FFFFFF å’Œ 0x80000000-0xFFFFFFFF
- **Hole**ï¼šå¦‚æœæŸäº›åœ°å€èŒƒå›´æ²¡æœ‰ç‰©ç†RAMï¼Œæ‰æ˜¯Hole

#### 2.1.6 Memblock API

```c
// Memblockåˆ†é…API
void *memblock_alloc(phys_addr_t size, phys_addr_t align);
void *memblock_alloc_raw(phys_addr_t size, phys_addr_t align);
void *memblock_alloc_from(phys_addr_t size, phys_addr_t align,
                         phys_addr_t min_addr);
void *memblock_alloc_low_memory(phys_addr_t size, phys_addr_t align);

// Memblocké‡Šæ”¾API
void memblock_free(void *ptr, phys_addr_t size);

// Memblocké¢„ç•™API
int memblock_reserve(phys_addr_t base, phys_addr_t size);
void memblock_remove(phys_addr_t base, phys_addr_t size);

// MemblockæŸ¥è¯¢API
phys_addr_t memblock_find_in_range(phys_addr_t start, phys_addr_t end,
                                   phys_addr_t size, phys_addr_t align);
bool memblock_is_memory(phys_addr_t addr);
bool memblock_is_reserved(phys_addr_t addr);
```

#### 2.1.7 Memblockåˆ°ä¼™ä¼´ç³»ç»Ÿçš„è½¬æ¢

```mermaid
sequenceDiagram
    participant BIOS as BIOS/Bootloader
    participant Bootloader as Bootloader
    participant Memblock as Memblock
    participant Kernel as å†…æ ¸
    participant Buddy as ä¼™ä¼´ç³»ç»Ÿ
    
    BIOS->>Memblock: 1. æä¾›å†…å­˜ä¿¡æ¯
    Bootloader->>Memblock: 2. ä¼ é€’å†…å­˜ä¿¡æ¯
    Memblock->>Memblock: 3. åˆå§‹åŒ–Memblock
    Memblock->>Kernel: 4. åˆ†é…å†…æ ¸å†…å­˜
    Kernel->>Memblock: 5. åˆå§‹åŒ–é¡µè¡¨
    Kernel->>Memblock: 6. åˆå§‹åŒ–ä¼™ä¼´ç³»ç»Ÿ
    Memblock->>Buddy: 7. ä¼ é€’MemoryåŒºåŸŸ
    Memblock->>Buddy: 8. ä¼ é€’ReservedåŒºåŸŸ
    Buddy->>Buddy: 9. åˆå§‹åŒ–free_area
    Memblock->>Memblock: 10. é‡Šæ”¾Memblock
    Buddy->>Kernel: 11. æ¥ç®¡å†…å­˜ç®¡ç†
    
    Note over BIOS,Buddy: Memblockä½¿å‘½å®Œæˆ
```

**è½¬æ¢è¿‡ç¨‹ï¼š**

1. **BIOS/Bootloaderæä¾›å†…å­˜ä¿¡æ¯**ï¼šé€šè¿‡e820å†…å­˜æ˜ å°„æˆ–è®¾å¤‡æ ‘ï¼ˆDTBï¼‰
2. **Bootloaderä¼ é€’ä¿¡æ¯**ï¼šå°†å†…å­˜ä¿¡æ¯ä¼ é€’ç»™å†…æ ¸
3. **Memblockåˆå§‹åŒ–**ï¼šæ ¹æ®å†…å­˜ä¿¡æ¯åˆå§‹åŒ–Memblock
4. **å†…æ ¸åˆ†é…å†…å­˜**ï¼šä½¿ç”¨Memblockåˆ†é…å†…æ ¸æ•°æ®ç»“æ„
5. **åˆå§‹åŒ–é¡µè¡¨**ï¼šå»ºç«‹é¡µè¡¨æ˜ å°„
6. **åˆå§‹åŒ–ä¼™ä¼´ç³»ç»Ÿ**ï¼šåˆ›å»ºä¼™ä¼´ç³»ç»Ÿæ•°æ®ç»“æ„
7. **ä¼ é€’å†…å­˜ä¿¡æ¯**ï¼šå°†Memoryå’ŒReservedåŒºåŸŸä¼ é€’ç»™ä¼™ä¼´ç³»ç»Ÿ
8. **é‡Šæ”¾Memblock**ï¼šMemblockä½¿å‘½å®Œæˆï¼Œé‡Šæ”¾èµ„æº
9. **ä¼™ä¼´ç³»ç»Ÿæ¥ç®¡**ï¼šä¼™ä¼´ç³»ç»Ÿæ¥ç®¡å†…å­˜ç®¡ç†

#### 2.1.8 Memblockè°ƒè¯•

```bash
# å¯åŠ¨å‚æ•°å¯ç”¨Memblockè°ƒè¯•
memblock=debug

# æŸ¥çœ‹Memblockä¿¡æ¯ï¼ˆåœ¨å†…æ ¸å¯åŠ¨æ—¥å¿—ä¸­ï¼‰
# æ—©æœŸå†…æ ¸æ—¥å¿—åŒ…å«Memblockä¿¡æ¯
dmesg | grep memblock

# ç¤ºä¾‹è¾“å‡ºï¼š
# memblock_reserve: [0x0000000000001000-0x000000000009ffff] reserve BIOS area
# memblock_reserve: [0x0000000000100000-0x0000000000ffffff] reserve kernel text
# memblock_reserve: [0x0000000001000000-0x0000000001ffffff] reserve kernel data
# memblock_reserve: [0x0000000080000000-0x000000008fffffff] reserve device registers
# memblock: memory: [0x0000000001000000-0x000000007fffffff] available
# memblock: memory: [0x0000000100000000-0x00000001ffffffff] available
```

#### 2.1.9 Memblockæ€»ç»“

```mermaid
mindmap
  root((Memblock))
    å®šä¹‰
      å†…æ ¸æ—©æœŸå†…å­˜ç®¡ç†å™¨
      Bootmemçš„æ›¿ä»£å“
      ä¸´æ—¶æ€§ä½¿ç”¨
    ä½œç”¨
      ç®¡ç†ç‰©ç†å†…å­˜
      é¢„ç•™å†…å­˜åŒºåŸŸ
      æ”¯æŒå†…å­˜é•œåƒ
    å†…å­˜ç±»å‹
      Memory å¯ç”¨å†…å­˜
      Reserved ä¿ç•™å†…å­˜
      Nomad æ— å½’å±å†…å­˜
    ç”Ÿå‘½å‘¨æœŸ
      å†…æ ¸å¯åŠ¨æ—¶ä½¿ç”¨
      ä¼™ä¼´ç³»ç»Ÿåˆå§‹åŒ–åé‡Šæ”¾
      ä¸ç”¨äºè¿è¡Œæ—¶
    é‡è¦æ¦‚å¿µ
      Hole: ç‰©ç†å†…å­˜ç©ºæ´
      Reserved: é¢„ç•™åŒºåŸŸ
      Memory: å¯ç”¨åŒºåŸŸ
```

**å…³é”®ç‚¹æ€»ç»“ï¼š**

1. **Memblockç®¡ç†çš„åŒºåŸŸä¸éƒ½æ˜¯Hole**
   - **Memory**ï¼šå¯ç”¨å†…å­˜ï¼Œå¯ä»¥åˆ†é…
   - **Reserved**ï¼šä¿ç•™å†…å­˜ï¼Œæœ‰ç‰¹å®šç”¨é€”
   - **Hole**ï¼šç‰©ç†å†…å­˜ç©ºæ´ï¼Œåœ°å€ä¸å­˜åœ¨

2. **Memblockæ˜¯ä¸´æ—¶å†…å­˜ç®¡ç†å™¨**
   - ä»…åœ¨å†…æ ¸å¯åŠ¨é˜¶æ®µä½¿ç”¨
   - ä¼™ä¼´ç³»ç»Ÿåˆå§‹åŒ–åé‡Šæ”¾
   - ä¸ç”¨äºè¿è¡Œæ—¶å†…å­˜åˆ†é…

3. **Memblockåˆ°ä¼™ä¼´ç³»ç»Ÿçš„è½¬æ¢**
   - Memblockä¼ é€’å†…å­˜ä¿¡æ¯ç»™ä¼™ä¼´ç³»ç»Ÿ
   - ä¼™ä¼´ç³»ç»Ÿæ¥ç®¡å†…å­˜ç®¡ç†
   - Memblockä½¿å‘½å®Œæˆ

---

## å››ã€é¡µé¢ç®¡ç†æœºåˆ¶

### 4.1 åˆ†é¡µæœºåˆ¶ (Linux 6.xå››çº§é¡µè¡¨)

```mermaid
graph TB
    A[64ä½è™šæ‹Ÿåœ°å€ 48ä½æœ‰æ•ˆ] --> B[PGD 9ä½]
    A --> C[PUD 9ä½]
    A --> D[PMD 9ä½]
    A --> E[PTE 9ä½]
    A --> F[Offset 12ä½]
    
    B --> G["é¡µå…¨å±€ç›®å½• PGD"]
    C --> H["é¡µä¸Šçº§ç›®å½• PUD"]
    D --> I["é¡µä¸­é—´ç›®å½• PMD"]
    E --> J["é¡µè¡¨ PTE"]
    F --> K["é¡µå†…åç§»"]
    
    G --> H --> I --> J --> K
    
    L[åœ°å€è½¬æ¢] --> M["è™šæ‹Ÿåœ°å€"]
    M --> N["æŸ¥PGD"]
    N --> O["æŸ¥PUD"]
    O --> P["æŸ¥PMD"]
    P --> Q["æŸ¥PTE"]
    Q --> R["ç‰©ç†åœ°å€"]
    
    style A fill:#e74c3c
    style L fill:#3498db
    style R fill:#2ecc71
```

#### é¡µè¡¨å±‚æ¬¡ç»“æ„

```mermaid
graph LR
    A[CR3å¯„å­˜å™¨] --> B[PGD]
    B --> C[PUD]
    C --> D[PMD]
    D --> E[PTE]
    E --> F[ç‰©ç†é¡µé¢]
    
    A --> A1["æŒ‡å‘å½“å‰è¿›ç¨‹PGD"]
    B --> B1["512é¡¹ Ã— 8å­—èŠ‚ = 4KB"]
    C --> C1["512é¡¹ Ã— 8å­—èŠ‚ = 4KB"]
    D --> D1["512é¡¹ Ã— 8å­—èŠ‚ = 4KB"]
    E --> E1["512é¡¹ Ã— 8å­—èŠ‚ = 4KB"]
    F --> F1["4KBé¡µé¢"]
    
    style A fill:#e74c3c
    style F fill:#2ecc71
```

### 4.2 é¡µé¢åˆ†é…æœºåˆ¶

#### ä¼™ä¼´ç³»ç»Ÿ

```mermaid
graph TB
    A[ä¼™ä¼´ç³»ç»ŸåŸç†] --> B["2^né˜¶é¡µé¢åˆ†é…"]
    A --> C["è¿ç»­ç‰©ç†é¡µé¢"]
    
    D[åˆ†é…ç¤ºä¾‹] --> E["åˆå§‹: 16é¡µ order=4"]
    E --> F["åˆ†é…8é¡µ: åˆ†è£‚ä¸ºä¸¤ä¸ª8é¡µ"]
    F --> G["å†åˆ†é…4é¡µ: åˆ†è£‚å‰©ä½™8é¡µ"]
    
    H[åˆå¹¶è§„åˆ™] --> I["ä¸¤ä¸ªç›¸åŒå¤§å°ç©ºé—²å—"]
    I --> J["åœ°å€è¿ç»­"]
    J --> K["åˆå¹¶ä¸ºæ›´å¤§å—"]
    K --> L["é€’å½’åˆå¹¶"]
    
    style A fill:#e74c3c
    style D fill:#3498db
    style H fill:#2ecc71
```

#### Slabåˆ†é…å™¨

```mermaid
graph TB
    A[Slabåˆ†é…å™¨] --> B[kmem_cache]
    B --> C[Slab 1 æ»¡]
    B --> D[Slab 2 éƒ¨åˆ†æ»¡]
    B --> E[Slab 3 ç©º]
    
    C --> F["Object1"]
    C --> G["Object2"]
    C --> H["Object3"]
    
    D --> I["Object1"]
    D --> J["Object2"]
    D --> K["ç©ºé—²"]
    
    E --> L["ç©ºé—²"]
    E --> M["ç©ºé—²"]
    E --> N["ç©ºé—²"]
    
    O[ä¼˜åŠ¿] --> P["å‡å°‘å†…å­˜ç¢ç‰‡"]
    O --> Q["æé«˜åˆ†é…é€Ÿåº¦"]
    O --> R["å¯¹è±¡é¢„åˆ†é…"]
    O --> S["åˆ©ç”¨å±€éƒ¨æ€§"]
    
    style A fill:#e74c3c
    style O fill:#3498db
```

### 4.3 é¡µé¢å›æ”¶æœºåˆ¶

```mermaid
graph TB
    A[å†…å­˜æ°´ä½çº¿] --> B[é«˜æ°´ä½çº¿ high]
    A --> C[ä½æ°´ä½çº¿ low]
    A --> D[æœ€ä½æ°´ä½çº¿ min]
    
    B --> B1["æ­£å¸¸çŠ¶æ€"]
    B --> B2["å†…å­˜å……è¶³"]
    
    C --> C1["å¼€å§‹å›æ”¶"]
    C --> C2["å”¤é†’kswapd"]
    
    D --> D1["ç´§æ€¥å›æ”¶"]
    D --> D2["åŒæ­¥ç›´æ¥å›æ”¶"]
    
    E[å›æ”¶ç­–ç•¥] --> F[æ–‡ä»¶é¡µé¢]
    E --> G[åŒ¿åé¡µé¢]
    
    F --> F1["å¹²å‡€é¡µé¢: ç›´æ¥é‡Šæ”¾"]
    F --> F2["è„é¡µé¢: å†™å›åé‡Šæ”¾"]
    
    G --> G1["äº¤æ¢åˆ°Swapåˆ†åŒº"]
    G --> G2["é‡Šæ”¾ç‰©ç†å†…å­˜"]
    
    style A fill:#e74c3c
    style E fill:#3498db
```

---

## äº”ã€å†…å­˜åˆ†é…ä¸å›æ”¶

### 5.1 å†…å­˜åˆ†é…æ¥å£

```mermaid
graph TB
    A[ç”¨æˆ·ç©ºé—´åˆ†é…] --> B[malloc/free]
    A --> C[new/delete]
    A --> D[mmap/munmap]
    
    B --> E[glibc ptmalloc2]
    E --> F[Arena ä¸»åˆ†é…åŒº]
    E --> G[Thread Cache]
    
    F --> H[brk å †æ‰©å±•]
    G --> I[mmap å¤§å—å†…å­˜]
    
    H --> J[å†…æ ¸brkç³»ç»Ÿè°ƒç”¨]
    I --> K[å†…æ ¸mmapç³»ç»Ÿè°ƒç”¨]
    
    J --> L[æ‰©å±•å †VMA]
    K --> M[åˆ›å»ºæ–°VMA]
    
    style A fill:#e74c3c
    style E fill:#3498db
```

#### å†…æ ¸ç©ºé—´å†…å­˜åˆ†é…

```mermaid
graph TB
    A[å†…æ ¸å†…å­˜åˆ†é…] --> B[kmalloc/kfree]
    A --> C[vmalloc/vfree]
    A --> D[alloc_pages]
    
    B --> E[Slab/Slubåˆ†é…å™¨]
    B --> F["å°å¯¹è±¡ <128KB"]
    B --> G["ç‰©ç†è¿ç»­"]
    
    C --> H[vmallocåˆ†é…å™¨]
    C --> I["å¤§å—å†…å­˜ >128KB"]
    C --> J["è™šæ‹Ÿè¿ç»­ï¼Œç‰©ç†å¯ä¸è¿ç»­"]
    
    D --> K[ä¼™ä¼´ç³»ç»Ÿ]
    D --> L["2^orderé¡µé¢"]
    D --> M["ç‰©ç†è¿ç»­"]
    
    E --> K
    H --> K
    
    style A fill:#e74c3c
    style K fill:#2ecc71
```

### 5.2 å†…å­˜å›æ”¶æœºåˆ¶

```mermaid
graph TB
    A[å†…å­˜å›æ”¶] --> B[é¡µé¢å›æ”¶ Paging]
    A --> C[å†…å­˜å‹ç¼© Compaction]
    A --> D[å†…å­˜å‹ç¼©æŠ€æœ¯]
    A --> E[å†…å­˜å»é‡ KSM]
    
    B --> B1[LRUç®—æ³•]
    B --> B2[æ°´ä½çº¿è§¦å‘]
    B --> B3[kswapdçº¿ç¨‹]
    
    C --> C1[æ¶ˆé™¤ç¢ç‰‡]
    C --> C2[åˆå¹¶ç©ºé—²é¡µé¢]
    C --> C3[åŒæ­¥/å¼‚æ­¥å‹ç¼©]
    
    D --> D1[zRAM]
    D --> D2[zSwap]
    D --> D3["å‹ç¼©æ¯” 2:1~3:1"]
    
    E --> E1[ç›¸åŒé¡µé¢åˆå¹¶]
    E --> E2[å†™æ—¶å¤åˆ¶COW]
    E --> E3[èŠ‚çœç‰©ç†å†…å­˜]
    
    style A fill:#e74c3c
    style D fill:#f39c12
    style E fill:#3498db
```

---

## å…­ã€äº¤æ¢æœºåˆ¶

### 6.1 äº¤æ¢ç©ºé—´ç®¡ç†

```mermaid
graph TB
    A[Swapç©ºé—´ç±»å‹] --> B[Swapåˆ†åŒº]
    A --> C[Swapæ–‡ä»¶]
    
    B --> B1["ç‹¬ç«‹åˆ†åŒº /dev/sda2"]
    B --> B2["æ€§èƒ½è¾ƒå¥½"]
    B --> B3["éœ€é¢„å…ˆè§„åˆ’"]
    
    C --> C1["æ–‡ä»¶ç³»ç»Ÿä¸Š /swapfile"]
    C --> C2["çµæ´»å¯è°ƒ"]
    C --> C3["æ€§èƒ½ç•¥å·®"]
    
    D[SwapåŠ å¯†] --> E[dm-crypt]
    E --> F["æé«˜å®‰å…¨æ€§"]
    E --> G["é˜²æ­¢æ•°æ®æ³„éœ²"]
    
    style A fill:#e74c3c
    style D fill:#f39c12
```

### 6.2 äº¤æ¢ç­–ç•¥

```mermaid
graph TB
    A[Swapè§¦å‘æœºåˆ¶] --> B[å†…å­˜å‹åŠ›æ£€æµ‹]
    B --> C[kswapdç›‘æ§]
    C --> D[ä½äºä½æ°´ä½çº¿]
    D --> E[æ ¹æ®swappinesså†³å®š]
    
    F[swappinesså‚æ•°] --> F1["0: å°½é‡ä¸Swap"]
    F --> F2["60: é»˜è®¤å¹³è¡¡"]
    F --> F3["100: ç§¯æSwap"]
    
    G[é¡µé¢ä¼˜å…ˆçº§] --> H[1. Inactive File]
    G --> I[2. Active File]
    G --> J[3. Inactive Anon]
    G --> K[4. Active Anon]
    
    style A fill:#e74c3c
    style F fill:#3498db
    style G fill:#f39c12
```

---

## ä¸ƒã€å†…å­˜æ˜ å°„

### 7.1 æ–‡ä»¶æ˜ å°„

```mermaid
graph TB
    A[mmapç³»ç»Ÿè°ƒç”¨] --> B[MAP_PRIVATE]
    A --> C[MAP_SHARED]
    
    B --> B1["å†™æ—¶å¤åˆ¶COW"]
    B --> B2["ä¿®æ”¹ä¸å†™å›æ–‡ä»¶"]
    B --> B3["è¿›ç¨‹ç‹¬ç«‹å‰¯æœ¬"]
    
    C --> C1["ä¿®æ”¹å†™å›æ–‡ä»¶"]
    C --> C2["è¿›ç¨‹å…±äº«æ˜ å°„"]
    C --> C3["è¿›ç¨‹é—´é€šä¿¡IPC"]
    
    D[å†™æ—¶å¤åˆ¶æµç¨‹] --> E["åˆå§‹: å¤šä¸ªè¿›ç¨‹å…±äº«åªè¯»é¡µé¢"]
    E --> F["è¿›ç¨‹Aå†™å…¥"]
    F --> G["åˆ›å»ºç§æœ‰å‰¯æœ¬"]
    G --> H["å…¶ä»–è¿›ç¨‹ä»å…±äº«åŸé¡µé¢"]
    
    style A fill:#e74c3c
    style D fill:#3498db
```

### 7.2 å†…å­˜æ˜ å°„ä¼˜åŒ–

```mermaid
graph TB
    A[ä¼˜åŒ–æŠ€æœ¯] --> B[MAP_POPULATE]
    A --> C[madvise]
    A --> D[readahead]
    A --> E[mlock]
    
    B --> B1["é¢„å¡«å……é¡µé¢"]
    B --> B2["é¿å…ç¼ºé¡µä¸­æ–­"]
    
    C --> C1[MADV_NORMAL]
    C --> C2[MADV_SEQUENTIAL]
    C --> C3[MADV_RANDOM]
    C --> C4[MADV_WILLNEED]
    
    D --> D1["ç³»ç»Ÿè‡ªåŠ¨é¢„è¯»å–"]
    D --> D2["å‡å°‘I/Oç­‰å¾…"]
    
    E --> E1["é”å®šå†…å­˜"]
    E --> E2["é˜²æ­¢è¢«æ¢å‡º"]
    
    style A fill:#e74c3c
    style C fill:#3498db
```

---

## å…«ã€NUMAæ¶æ„

### 8.0 CPUä¸æ ¸å¿ƒçš„å…³ç³»

åœ¨ç†è§£NUMAæ¶æ„ä¹‹å‰ï¼Œéœ€è¦å…ˆç†è§£CPUã€æ ¸å¿ƒå’Œçº¿ç¨‹çš„å…³ç³»ã€‚

#### 8.0.1 åŸºæœ¬æ¦‚å¿µ

```mermaid
graph TB
    A[å¤„ç†å™¨ Processor] --> B[ç‰©ç†CPU Physical CPU]
    A --> C[æ ¸å¿ƒ Core]
    A --> D[çº¿ç¨‹ Thread]
    
    B --> B1["ä¸€ä¸ªç‰©ç†CPUèŠ¯ç‰‡"]
    B --> B2["å¯ä»¥åŒ…å«å¤šä¸ªæ ¸å¿ƒ"]
    
    C --> C1["ç‹¬ç«‹æ‰§è¡Œå•å…ƒ"]
    C --> C2["æ¯ä¸ªæ ¸å¿ƒæœ‰è‡ªå·±çš„å¯„å­˜å™¨ã€L1/L2ç¼“å­˜"]
    C --> C3["ä¸€ä¸ªCPUå¯ä»¥æœ‰å¤šä¸ªæ ¸å¿ƒ"]
    
    D --> D1["è¶…çº¿ç¨‹æŠ€æœ¯"]
    D --> D2["ä¸€ä¸ªæ ¸å¿ƒå¯ä»¥æ¨¡æ‹Ÿå¤šä¸ªçº¿ç¨‹"]
    D --> D3["æ“ä½œç³»ç»Ÿçœ‹åˆ°çš„æ˜¯é€»è¾‘CPU"]
    
    E[å…³ç³»] --> F["1ä¸ªç‰©ç†CPU"]
    E --> G["åŒ…å«Nä¸ªæ ¸å¿ƒ"]
    E --> H["æ¯ä¸ªæ ¸å¿ƒå¯ä»¥æœ‰Mä¸ªçº¿ç¨‹"]
    E --> I["é€»è¾‘CPUæ•° = N Ã— M"]
    
    style A fill:#e74c3c
    style E fill:#3498db
    style I fill:#2ecc71
```

**æ ¸å¿ƒæ¦‚å¿µï¼š**

| æ¦‚å¿µ | å®šä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| **ç‰©ç†CPU** | æ’åœ¨ä¸»æ¿ä¸Šçš„CPUèŠ¯ç‰‡ | ä¸»æ¿ä¸Šæœ‰2ä¸ªCPUæ’æ§½ |
| **æ ¸å¿ƒ Core** | CPUå†…éƒ¨çš„ç‹¬ç«‹æ‰§è¡Œå•å…ƒ | ä¸€ä¸ªCPUæœ‰8ä¸ªæ ¸å¿ƒ |
| **çº¿ç¨‹ Thread** | é€šè¿‡è¶…çº¿ç¨‹æŠ€æœ¯æ¨¡æ‹Ÿçš„æ‰§è¡Œå•å…ƒ | ä¸€ä¸ªæ ¸å¿ƒæœ‰2ä¸ªçº¿ç¨‹ |

**é‡è¦å…¬å¼ï¼š**
```
é€»è¾‘CPUæ•° = ç‰©ç†CPUæ•° Ã— æ¯ä¸ªCPUçš„æ ¸å¿ƒæ•° Ã— æ¯ä¸ªæ ¸å¿ƒçš„çº¿ç¨‹æ•°
```

#### 8.0.2 ç‰©ç†CPUï¼ˆPhysical CPUï¼‰

```mermaid
graph TB
    A[ç‰©ç†CPUèŠ¯ç‰‡] --> B["CPU0"]
    A --> C["CPU1"]
    
    B --> B1["æ’åœ¨ä¸»æ¿ä¸Šçš„CPU"]
    B --> B2["ä¸€ä¸ªç‹¬ç«‹çš„ç‰©ç†å¤„ç†å™¨"]
    
    C --> C1["æ’åœ¨ä¸»æ¿ä¸Šçš„CPU"]
    C --> C2["å¦ä¸€ä¸ªç‹¬ç«‹çš„ç‰©ç†å¤„ç†å™¨"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#3498db
```

**ç‰©ç†CPU** = æ’åœ¨ä¸»æ¿ä¸Šçš„CPUèŠ¯ç‰‡ï¼Œä¸€ä¸ªä¸»æ¿å¯ä»¥æœ‰å¤šä¸ªç‰©ç†CPUã€‚

#### 8.0.3 æ ¸å¿ƒï¼ˆCoreï¼‰

```mermaid
graph TB
    A[ç‰©ç†CPU] --> B[æ ¸å¿ƒ0]
    A --> C[æ ¸å¿ƒ1]
    A --> D[æ ¸å¿ƒ2]
    A --> E[æ ¸å¿ƒ3]
    
    B --> B1["ç‹¬ç«‹æ‰§è¡Œå•å…ƒ"]
    B --> B2["æœ‰è‡ªå·±çš„L1/L2ç¼“å­˜"]
    
    C --> C1["ç‹¬ç«‹æ‰§è¡Œå•å…ƒ"]
    C --> C2["æœ‰è‡ªå·±çš„L1/L2ç¼“å­˜"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#3498db
    style D fill:#3498db
    style E fill:#3498db
```

**æ ¸å¿ƒ** = CPUå†…éƒ¨çš„ç‹¬ç«‹æ‰§è¡Œå•å…ƒï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„å¯„å­˜å™¨å’ŒL1/L2ç¼“å­˜ã€‚ä¸€ä¸ªç‰©ç†CPUå¯ä»¥åŒ…å«å¤šä¸ªæ ¸å¿ƒã€‚

#### 8.0.4 çº¿ç¨‹ï¼ˆThreadï¼‰- è¶…çº¿ç¨‹

```mermaid
graph TB
    A[æ ¸å¿ƒ Core] --> B[çº¿ç¨‹0]
    A --> C[çº¿ç¨‹1]
    
    B --> B1["é€»è¾‘CPU 0"]
    C --> C2["é€»è¾‘CPU 1"]
    
    D[è¶…çº¿ç¨‹æŠ€æœ¯] --> E["ä¸€ä¸ªæ ¸å¿ƒåŒæ—¶å¤„ç†ä¸¤ä¸ªçº¿ç¨‹"]
    D --> F["æé«˜èµ„æºåˆ©ç”¨ç‡"]
    D --> G["ä¸æ˜¯çœŸæ­£çš„åŒæ ¸"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#f39c12
    style D fill:#2ecc71
```

**çº¿ç¨‹** = é€šè¿‡è¶…çº¿ç¨‹æŠ€æœ¯ï¼Œä¸€ä¸ªæ ¸å¿ƒå¯ä»¥æ¨¡æ‹Ÿå‡ºå¤šä¸ªé€»è¾‘CPUï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡ã€‚

**æ³¨æ„ï¼š** è¶…çº¿ç¨‹ä¸æ˜¯çœŸæ­£çš„åŒæ ¸ï¼Œåªæ˜¯è®©ä¸€ä¸ªæ ¸å¿ƒèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°åˆ©ç”¨èµ„æºã€‚

#### 8.0.5 å®é™…ä¾‹å­

##### ä¾‹å­1ï¼šå•CPUåŒæ ¸åŒçº¿ç¨‹

```mermaid
graph TB
    A["ç‰©ç†CPU 1"] --> B["æ ¸å¿ƒ 0"]
    A --> C["æ ¸å¿ƒ 1"]
    
    B --> D["çº¿ç¨‹ 0"]
    B --> E["çº¿ç¨‹ 1"]
    
    C --> F["çº¿ç¨‹ 2"]
    C --> G["çº¿ç¨‹ 3"]
    
    H["ç»Ÿè®¡"] --> I["ç‰©ç†CPUæ•°: 1"]
    H --> J["æ ¸å¿ƒæ•°: 2"]
    H --> K["çº¿ç¨‹æ•°: 4"]
    H --> L["é€»è¾‘CPUæ•°: 4"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#3498db
    style H fill:#2ecc71
```

**é…ç½®ï¼š**
- ç‰©ç†CPUæ•°ï¼š1
- æ ¸å¿ƒæ•°ï¼š2
- æ¯æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š2
- é€»è¾‘CPUæ•°ï¼š1 Ã— 2 Ã— 2 = 4

##### ä¾‹å­2ï¼šåŒCPUå››æ ¸åŒçº¿ç¨‹

```mermaid
graph TB
    A["ç‰©ç†CPU 0"] --> B["æ ¸å¿ƒ 0"]
    A --> C["æ ¸å¿ƒ 1"]
    A --> D["æ ¸å¿ƒ 2"]
    A --> E["æ ¸å¿ƒ 3"]
    
    F["ç‰©ç†CPU 1"] --> G["æ ¸å¿ƒ 4"]
    F --> H["æ ¸å¿ƒ 5"]
    F --> I["æ ¸å¿ƒ 6"]
    F --> J["æ ¸å¿ƒ 7"]
    
    B --> K["çº¿ç¨‹ 0,1"]
    C --> L["çº¿ç¨‹ 2,3"]
    D --> M["çº¿ç¨‹ 4,5"]
    E --> N["çº¿ç¨‹ 6,7"]
    
    G --> O["çº¿ç¨‹ 8,9"]
    H --> P["çº¿ç¨‹ 10,11"]
    I --> Q["çº¿ç¨‹ 12,13"]
    J --> R["çº¿ç¨‹ 14,15"]
    
    S["ç»Ÿè®¡"] --> T["ç‰©ç†CPUæ•°: 2"]
    S --> U["æ ¸å¿ƒæ•°: 8"]
    S --> V["çº¿ç¨‹æ•°: 16"]
    S --> W["é€»è¾‘CPUæ•°: 16"]
    
    style A fill:#e74c3c
    style F fill:#e74c3c
    style S fill:#2ecc71
```

**é…ç½®ï¼š**
- ç‰©ç†CPUæ•°ï¼š2
- æ ¸å¿ƒæ•°ï¼š8ï¼ˆæ¯ä¸ªCPU 4ä¸ªæ ¸å¿ƒï¼‰
- æ¯æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š2
- é€»è¾‘CPUæ•°ï¼š2 Ã— 4 Ã— 2 = 16

##### ä¾‹å­3ï¼š8æ ¸é…ç½®å¯¹æ¯”

###### é…ç½®1ï¼š8æ ¸ï¼ˆ4å¤§æ ¸ + 4å°æ ¸ï¼‰

```mermaid
graph TB
    A["å•ç‰©ç†CPU"] --> B["å¤§æ ¸ x4"]
    A --> C["å°æ ¸ x4"]
    
    B --> B1["æ ¸å¿ƒ0: æ€§èƒ½æ ¸"]
    B --> B2["æ ¸å¿ƒ1: æ€§èƒ½æ ¸"]
    B --> B3["æ ¸å¿ƒ2: æ€§èƒ½æ ¸"]
    B --> B4["æ ¸å¿ƒ3: æ€§èƒ½æ ¸"]
    
    C --> C1["æ ¸å¿ƒ4: èƒ½æ•ˆæ ¸"]
    C --> C2["æ ¸å¿ƒ5: èƒ½æ•ˆæ ¸"]
    C --> C3["æ ¸å¿ƒ6: èƒ½æ•ˆæ ¸"]
    C --> C4["æ ¸å¿ƒ7: èƒ½æ•ˆæ ¸"]
    
    D["ç»Ÿè®¡"] --> E["ç‰©ç†CPUæ•°: 1"]
    D --> F["æ ¸å¿ƒæ•°: 8"]
    D --> G["å¤§æ ¸: 4ä¸ª"]
    D --> H["å°æ ¸: 4ä¸ª"]
    D --> I["é€»è¾‘CPUæ•°: 8"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#f39c12
    style D fill:#2ecc71
```

**é…ç½®ï¼š**
- ç‰©ç†CPUæ•°ï¼š1
- æ ¸å¿ƒæ•°ï¼š8ï¼ˆ4å¤§æ ¸ + 4å°æ ¸ï¼‰
- æ²¡æœ‰è¶…çº¿ç¨‹
- é€»è¾‘CPUæ•°ï¼š8

**ç‰¹ç‚¹ï¼š**
- å¼‚æ„æ ¸å¿ƒè®¾è®¡
- å¤§æ ¸å¤„ç†é«˜æ€§èƒ½ä»»åŠ¡
- å°æ ¸å¤„ç†ä½åŠŸè€—ä»»åŠ¡
- é€‚åˆæ··åˆè´Ÿè½½

###### é…ç½®2ï¼š8æ ¸ï¼ˆå…¨å¤§æ ¸ï¼‰

```mermaid
graph TB
    A["å•ç‰©ç†CPU"] --> B["å¤§æ ¸ x8"]
    
    B --> B1["æ ¸å¿ƒ0: æ€§èƒ½æ ¸"]
    B --> B2["æ ¸å¿ƒ1: æ€§èƒ½æ ¸"]
    B --> B3["æ ¸å¿ƒ2: æ€§èƒ½æ ¸"]
    B --> B4["æ ¸å¿ƒ3: æ€§èƒ½æ ¸"]
    B --> B5["æ ¸å¿ƒ4: æ€§èƒ½æ ¸"]
    B --> B6["æ ¸å¿ƒ5: æ€§èƒ½æ ¸"]
    B --> B7["æ ¸å¿ƒ6: æ€§èƒ½æ ¸"]
    B --> B8["æ ¸å¿ƒ7: æ€§èƒ½æ ¸"]
    
    C["ç»Ÿè®¡"] --> D["ç‰©ç†CPUæ•°: 1"]
    C --> E["æ ¸å¿ƒæ•°: 8"]
    C --> F["å¤§æ ¸: 8ä¸ª"]
    C --> G["é€»è¾‘CPUæ•°: 8"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
```

**é…ç½®ï¼š**
- ç‰©ç†CPUæ•°ï¼š1
- æ ¸å¿ƒæ•°ï¼š8ï¼ˆå…¨æ˜¯å¤§æ ¸ï¼‰
- æ²¡æœ‰è¶…çº¿ç¨‹
- é€»è¾‘CPUæ•°ï¼š8

**ç‰¹ç‚¹ï¼š**
- åŒæ„æ ¸å¿ƒè®¾è®¡
- æ‰€æœ‰æ ¸å¿ƒæ€§èƒ½ç›¸åŒ
- é€‚åˆé«˜æ€§èƒ½è®¡ç®—
- æ€§èƒ½å‡è¡¡

#### 8.0.6 æŸ¥çœ‹ç³»ç»ŸCPUä¿¡æ¯

```bash
# æŸ¥çœ‹CPUä¿¡æ¯
lscpu

# è¾“å‡ºç¤ºä¾‹ï¼š
# CPU(s):                8
# On-line CPU(s) list:   0-7
# Thread(s) per core:    1
# Core(s) per socket:    8
# Socket(s):             1

# è§£é‡Šï¼š
# CPU(s): 8              = é€»è¾‘CPUæ€»æ•°
# Socket(s): 1           = ç‰©ç†CPUæ•°
# Core(s) per socket: 8  = æ¯ä¸ªç‰©ç†CPUçš„æ ¸å¿ƒæ•°
# Thread(s) per core: 1  = æ¯ä¸ªæ ¸å¿ƒçš„çº¿ç¨‹æ•°
```

#### 8.0.7 æ€»ç»“

```mermaid
mindmap
  root((CPU vs Core))
    ç‰©ç†CPU
      æ’åœ¨ä¸»æ¿ä¸Šçš„èŠ¯ç‰‡
      å¯ä»¥æœ‰å¤šä¸ª
      æ¯ä¸ªCPUåŒ…å«å¤šä¸ªæ ¸å¿ƒ
    æ ¸å¿ƒ Core
      CPUå†…éƒ¨çš„æ‰§è¡Œå•å…ƒ
      ç‹¬ç«‹çš„å¯„å­˜å™¨å’Œç¼“å­˜
      çœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œèƒ½åŠ›
    çº¿ç¨‹ Thread
      è¶…çº¿ç¨‹æŠ€æœ¯
      ä¸€ä¸ªæ ¸å¿ƒæ¨¡æ‹Ÿå¤šä¸ªçº¿ç¨‹
      æé«˜èµ„æºåˆ©ç”¨ç‡
    å…³ç³»å…¬å¼
      é€»è¾‘CPU = ç‰©ç†CPU Ã— æ¯CPUæ ¸å¿ƒæ•° Ã— æ¯æ ¸å¿ƒçº¿ç¨‹æ•°
    ç®€å•ç†è§£
      ç‰©ç†CPU = èŠ¯ç‰‡
      æ ¸å¿ƒ = èŠ¯ç‰‡å†…çš„å¤„ç†å™¨
      çº¿ç¨‹ = è¶…çº¿ç¨‹æŠ€æœ¯æ¨¡æ‹Ÿçš„å¤„ç†å™¨
```

**ç®€å•è®°å¿†ï¼š**

- **ç‰©ç†CPU** = èŠ¯ç‰‡ï¼ˆæ’åœ¨ä¸»æ¿ä¸Šçš„ï¼‰
- **æ ¸å¿ƒ** = èŠ¯ç‰‡é‡Œçš„å¤„ç†å™¨ï¼ˆä¸€ä¸ªèŠ¯ç‰‡å¯ä»¥æœ‰å¤šä¸ªï¼‰
- **çº¿ç¨‹** = è¶…çº¿ç¨‹æŠ€æœ¯ï¼ˆä¸€ä¸ªæ ¸å¿ƒå¯ä»¥æ¨¡æ‹Ÿå¤šä¸ªï¼‰

**é‡è¦ï¼š** ä¸æ˜¯"ä¸€ä¸ªæ ¸åŒ…æ‹¬å¤šä¸ªCPU"ï¼Œè€Œæ˜¯"ä¸€ä¸ªCPUåŒ…æ‹¬å¤šä¸ªæ ¸å¿ƒ"ï¼

#### 8.0.8 å®é™…èŠ¯ç‰‡æ¡ˆä¾‹ï¼šMT8676è½¦æœºåº§èˆ±èŠ¯ç‰‡

MT8676æ˜¯è”å‘ç§‘ï¼ˆMediaTekï¼‰ä¸“ä¸ºæ™ºèƒ½åº§èˆ±è®¾è®¡çš„SoCèŠ¯ç‰‡ï¼Œå¹¿æ³›åº”ç”¨äºè½¦æœºç³»ç»Ÿã€‚

##### 8.0.8.1 èŠ¯ç‰‡åŸºæœ¬ä¿¡æ¯

```mermaid
graph TB
    A["MT8676 SoCèŠ¯ç‰‡"] --> B["å‚å•†: è”å‘ç§‘ MediaTek"]
    A --> C["ç³»åˆ—: Kompanio"]
    A --> D["å®šä½: æ™ºèƒ½åº§èˆ±"]
    A --> E["åˆ¶ç¨‹: 6nm"]
    
    F["æ ¸å¿ƒé…ç½®"] --> G["ç‰©ç†CPU: 1ä¸ª"]
    F --> H["æ ¸å¿ƒæ•°: 8ä¸ª"]
    F --> I["æ¶æ„: ARMv8"]
    
    J["æ ¸å¿ƒç±»å‹"] --> K["å¤§æ ¸: 4ä¸ª Cortex-A78"]
    J --> L["å°æ ¸: 4ä¸ª Cortex-A55"]
    
    M["åº”ç”¨åœºæ™¯"] --> N["è½¦è½½å¨±ä¹ç³»ç»Ÿ"]
    M --> O["å¯¼èˆªç³»ç»Ÿ"]
    M --> P["è¯­éŸ³åŠ©æ‰‹"]
    M --> Q["OTAå‡çº§"]
    M --> R["å¤šå±æ˜¾ç¤º"]
    
    style A fill:#e74c3c
    style F fill:#3498db
    style J fill:#2ecc71
    style M fill:#f39c12
```

**åŸºæœ¬è§„æ ¼ï¼š**

| é¡¹ç›® | è§„æ ¼ |
|------|------|
| **å‚å•†** | è”å‘ç§‘ï¼ˆMediaTekï¼‰ |
| **ç³»åˆ—** | Kompanio |
| **åˆ¶ç¨‹** | 6nm |
| **ç‰©ç†CPU** | 1ä¸ªSoCèŠ¯ç‰‡ |
| **æ ¸å¿ƒæ•°** | 8æ ¸ |
| **æ¶æ„** | ARMv8 |
| **å¤§æ ¸** | 4Ã— Cortex-A78 |
| **å°æ ¸** | 4Ã— Cortex-A55 |

##### 8.0.8.2 CPUè¯¦ç»†é…ç½®

```mermaid
graph TB
    A["MT8676 CPUå­ç³»ç»Ÿ"] --> B["å¤§æ ¸é›†ç¾¤"]
    A --> C["å°æ ¸é›†ç¾¤"]
    
    B --> B1["Cortex-A78 x4"]
    B --> B2["ä¸»é¢‘: æœ€é«˜2.2GHz"]
    B --> B3["L2ç¼“å­˜: 512KB/æ ¸å¿ƒ"]
    B --> B4["L3å…±äº«ç¼“å­˜: 4MB"]
    
    C --> C1["Cortex-A55 x4"]
    C --> C2["ä¸»é¢‘: æœ€é«˜2.0GHz"]
    C --> C3["L2ç¼“å­˜: 128KB/æ ¸å¿ƒ"]
    C --> C4["å…±äº«L3ç¼“å­˜: 4MB"]
    
    D["æ€§èƒ½å¯¹æ¯”"] --> E["A78: é«˜æ€§èƒ½"]
    D --> F["A55: é«˜èƒ½æ•ˆ"]
    D --> G["åŠ¨æ€è°ƒåº¦"]
    
    H["è°ƒåº¦ç­–ç•¥"] --> I["è®¡ç®—å¯†é›†: A78"]
    H --> J["åå°ä»»åŠ¡: A55"]
    H --> K["åŠŸè€—ä¼˜åŒ–: æ··åˆä½¿ç”¨"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#f39c12
    style H fill:#2ecc71
```

**å¤§æ ¸ï¼ˆCortex-A78ï¼‰ï¼š**
- æ•°é‡ï¼š4ä¸ª
- ä¸»é¢‘ï¼šæœ€é«˜2.2GHz
- L2ç¼“å­˜ï¼š512KB/æ ¸å¿ƒ
- ç”¨é€”ï¼šå¤„ç†å¤æ‚è®¡ç®—ã€3Dæ¸²æŸ“ã€AIæ¨ç†

**å°æ ¸ï¼ˆCortex-A55ï¼‰ï¼š**
- æ•°é‡ï¼š4ä¸ª
- ä¸»é¢‘ï¼šæœ€é«˜2.0GHz
- L2ç¼“å­˜ï¼š128KB/æ ¸å¿ƒ
- ç”¨é€”ï¼šå¤„ç†åå°ä»»åŠ¡ã€è½»é‡çº§åº”ç”¨ã€çœç”µæ¨¡å¼

##### 8.0.8.3 GPUé…ç½®

```mermaid
graph TB
    A["MT8676 GPUå­ç³»ç»Ÿ"] --> B["å‹å·: Arm Mali-G57"]
    A --> C["æ ¸å¿ƒæ•°: MC5"]
    A --> D["ä¸»é¢‘: æœ€é«˜950MHz"]
    
    E["å›¾å½¢èƒ½åŠ›"] --> F["æ”¯æŒOpenGL ES 3.2"]
    E --> G["æ”¯æŒVulkan 1.1"]
    E --> H["æ”¯æŒOpenCL 2.2"]
    
    I["æ˜¾ç¤ºèƒ½åŠ›"] --> J["4K@60fps"]
    I --> K["å¤šå±æ˜¾ç¤ºæ”¯æŒ"]
    I --> L["HDRæ”¯æŒ"]
    
    M["åº”ç”¨åœºæ™¯"] --> N["è½¦è½½UIæ¸²æŸ“"]
    M --> O["å¯¼èˆª3Dæ¸²æŸ“"]
    M --> P["æ¸¸æˆ"]
    
    style A fill:#e74c3c
    style E fill:#3498db
    style I fill:#2ecc71
    style M fill:#f39c12
```

**GPUè§„æ ¼ï¼š**
- å‹å·ï¼šArm Mali-G57 MC5
- æ ¸å¿ƒæ•°ï¼š5æ ¸å¿ƒ
- ä¸»é¢‘ï¼šæœ€é«˜950MHz
- APIæ”¯æŒï¼šOpenGL ES 3.2ã€Vulkan 1.1ã€OpenCL 2.2

##### 8.0.8.4 å†…å­˜é…ç½®

```mermaid
graph TB
    A["MT8676å†…å­˜å­ç³»ç»Ÿ"] --> B["ç±»å‹: LPDDR4X"]
    A --> C["é¢‘ç‡: 2133MHz"]
    A --> D["å®¹é‡: æœ€é«˜8GB"]
    
    E["å†…å­˜æ§åˆ¶å™¨"] --> F["åŒé€šé“"]
    E --> G["32ä½æ€»çº¿å®½åº¦"]
    E --> H["å¸¦å®½: 17GB/s"]
    
    I["å†…å­˜ç®¡ç†"] --> J["NUMA: å•èŠ‚ç‚¹"]
    I --> K["ç»Ÿä¸€å†…å­˜æ¶æ„"]
    I --> L["CPU/GPUå…±äº«"]
    
    M["ç‰¹ç‚¹"] --> N["ä½åŠŸè€—"]
    M --> O["é«˜æ€§èƒ½"]
    M --> P["æ”¯æŒçƒ­æ’æ‹”"]
    
    style A fill:#e74c3c
    style E fill:#3498db
    style I fill:#2ecc71
    style M fill:#f39c12
```

**å†…å­˜è§„æ ¼ï¼š**
- ç±»å‹ï¼šLPDDR4X
- é¢‘ç‡ï¼š2133MHz
- å®¹é‡ï¼šæœ€é«˜8GB
- å¸¦å®½ï¼š17GB/sï¼ˆåŒé€šé“ï¼‰
- NUMAæ¶æ„ï¼šå•èŠ‚ç‚¹ï¼ˆéNUMAï¼‰

**é‡è¦ï¼š** MT8676æ˜¯å•èŠ‚ç‚¹è®¾è®¡ï¼Œä¸å­˜åœ¨NUMAè·¨èŠ‚ç‚¹è®¿é—®çš„é—®é¢˜ã€‚

##### 8.0.8.5 è§†é¢‘å¤„ç†èƒ½åŠ›

```mermaid
graph TB
    A["MT8676è§†é¢‘å­ç³»ç»Ÿ"] --> B["ç¼–è§£ç å™¨"]
    A --> C["æ˜¾ç¤ºæ§åˆ¶å™¨"]
    
    B --> B1["H.264/H.265"]
    B --> B2["VP9"]
    B --> B3["4K@60fpsè§£ç "]
    B --> B4["4K@30fpsç¼–ç "]
    
    C --> C1["æ”¯æŒå¤šå±è¾“å‡º"]
    C --> C2["HDMIè¾“å‡º"]
    C --> C3["LVDS/MIPIè¾“å‡º"]
    C --> C4["æœ€å¤§åˆ†è¾¨ç‡: 4K"]
    
    D["åº”ç”¨åœºæ™¯"] --> E["è½¦è½½å¨±ä¹"]
    D --> F["å€’è½¦å½±åƒ"]
    D --> G["360åº¦ç¯è§†"]
    D --> H["è¡Œè½¦è®°å½•"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
    style D fill:#f39c12
```

**è§†é¢‘èƒ½åŠ›ï¼š**
- è§£ç ï¼šH.264/H.265/VP9ï¼Œ4K@60fps
- ç¼–ç ï¼šH.264/H.265ï¼Œ4K@30fps
- æ˜¾ç¤ºï¼šå¤šå±è¾“å‡ºï¼Œæœ€å¤§4Kåˆ†è¾¨ç‡

##### 8.0.8.6 AIå¤„ç†èƒ½åŠ›

```mermaid
graph TB
    A["MT8676 AIå­ç³»ç»Ÿ"] --> B["APU: AIå¤„ç†å•å…ƒ"]
    A --> C["NPU: ç¥ç»ç½‘ç»œå¤„ç†å™¨"]
    
    B --> B1["æµ®ç‚¹è¿ç®—: 0.5 TFLOPS"]
    B --> B2["AIæ¨ç†åŠ é€Ÿ"]
    
    C --> C1["INT8: 2 TOPS"]
    C --> C2["ç¥ç»ç½‘ç»œåŠ é€Ÿ"]
    C --> C3["ä½åŠŸè€—AI"]
    
    D["AIåº”ç”¨"] --> E["è¯­éŸ³è¯†åˆ«"]
    D --> F["äººè„¸è¯†åˆ«"]
    D --> G["é©¾é©¶å‘˜ç›‘æµ‹"]
    D --> H["æ‰‹åŠ¿è¯†åˆ«"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#f39c12
    style D fill:#2ecc71
```

**AIèƒ½åŠ›ï¼š**
- APUï¼š0.5 TFLOPSæµ®ç‚¹è¿ç®—
- NPUï¼š2 TOPS INT8æ€§èƒ½
- åº”ç”¨ï¼šè¯­éŸ³è¯†åˆ«ã€äººè„¸è¯†åˆ«ã€é©¾é©¶å‘˜ç›‘æµ‹

##### 8.0.8.7 æ¥å£æ”¯æŒ

```mermaid
graph TB
    A["MT8676æ¥å£"] --> B["å­˜å‚¨æ¥å£"]
    A --> C["ç½‘ç»œæ¥å£"]
    A --> D["æ˜¾ç¤ºæ¥å£"]
    A --> E["å¤–è®¾æ¥å£"]
    
    B --> B1["eMMC 5.1"]
    B --> B2["UFS 2.1"]
    B --> B3["SD 3.0"]
    
    C --> C1["WiFi 6"]
    C --> C2["è“ç‰™5.0"]
    C --> C3["GPS/GNSS"]
    
    D --> D1["HDMI 2.0"]
    D --> D2["LVDS"]
    D --> D3["MIPI DSI"]
    
    E --> E1["USB 3.0"]
    E --> E2["PCIe 3.0"]
    E --> E3["I2C/SPI/GPIO"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
    style D fill:#f39c12
    style E fill:#9b59b6
```

**æ¥å£æ”¯æŒï¼š**
- å­˜å‚¨ï¼šeMMC 5.1ã€UFS 2.1ã€SD 3.0
- ç½‘ç»œï¼šWiFi 6ã€è“ç‰™5.0ã€GPS
- æ˜¾ç¤ºï¼šHDMI 2.0ã€LVDSã€MIPI DSI
- å¤–è®¾ï¼šUSB 3.0ã€PCIe 3.0ã€I2C/SPI/GPIO

##### 8.0.8.8 å†…å­˜ç®¡ç†ç‰¹æ€§

```mermaid
graph TB
    A["MT8676å†…å­˜ç®¡ç†"] --> B["å•èŠ‚ç‚¹æ¶æ„"]
    A --> C["ç»Ÿä¸€å†…å­˜"]
    A --> D["GPUå…±äº«"]
    
    B --> B1["æ— NUMAè·¨èŠ‚ç‚¹é—®é¢˜"]
    B --> B2["è®¿é—®å»¶è¿Ÿä¸€è‡´"]
    B --> B3["ç®€åŒ–å†…å­˜ç®¡ç†"]
    
    C --> C1["CPUå’ŒGPUå…±äº«ç‰©ç†å†…å­˜"]
    C --> C2["æ•°æ®é›¶æ‹·è´"]
    C --> C3["é™ä½å»¶è¿Ÿ"]
    
    D --> D1["GPUç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜"]
    D --> D2["æ— éœ€æ˜¾å­˜"]
    D --> D3["èŠ‚çœæˆæœ¬"]
    
    E["Linuxå†…æ ¸æ”¯æŒ"] --> F["CMA: è¿ç»­å†…å­˜åˆ†é…å™¨"]
    E --> G["ION: å†…å­˜ç®¡ç†æ¡†æ¶"]
    E --> H["DMA-BUF: ç¼“å†²åŒºå…±äº«"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
    style D fill:#f39c12
    style E fill:#9b59b6
```

**å†…å­˜ç®¡ç†ç‰¹ç‚¹ï¼š**
- å•èŠ‚ç‚¹æ¶æ„ï¼Œæ— NUMAé—®é¢˜
- CPU/GPUç»Ÿä¸€å†…å­˜
- æ”¯æŒCMAã€IONã€DMA-BUF

##### 8.0.8.9 å¼€å‘ç›¸å…³

```bash
# æŸ¥çœ‹MT8676 CPUä¿¡æ¯
cat /proc/cpuinfo

# è¾“å‡ºç¤ºä¾‹ï¼š
# processor	: 0-7
# Hardware	: MT8676
# CPU implementer	: 0x41 (ARM)
# CPU part	: 0xd41 (Cortex-A78) æˆ– 0xd05 (Cortex-A55)

# æŸ¥çœ‹å†…å­˜ä¿¡æ¯
cat /proc/meminfo

# æŸ¥çœ‹NUMAèŠ‚ç‚¹ï¼ˆMT8676åªæœ‰1ä¸ªèŠ‚ç‚¹ï¼‰
numactl --hardware

# è¾“å‡ºç¤ºä¾‹ï¼š
# available: 1 nodes (0)
# node 0 size: 8192 MB
# node 0 free: 4096 MB

# æŸ¥çœ‹CPUäº²å’Œæ€§
taskset -pc

# æŸ¥çœ‹å†…å­˜æ˜ å°„
cat /proc/self/maps

# æŸ¥çœ‹GPUä¿¡æ¯
cat /sys/class/mali0/device/gpuinfo
```

##### 8.0.8.10 æ€§èƒ½ä¼˜åŒ–å»ºè®®

```mermaid
graph TB
    A["MT8676æ€§èƒ½ä¼˜åŒ–"] --> B["CPUè°ƒåº¦"]
    A --> C["å†…å­˜ç®¡ç†"]
    A --> D["GPUä¼˜åŒ–"]
    
    B --> B1["å¤§æ ¸å¤„ç†è®¡ç®—å¯†é›†ä»»åŠ¡"]
    B --> B2["å°æ ¸å¤„ç†åå°ä»»åŠ¡"]
    B --> B3["ä½¿ç”¨CPUäº²å’Œæ€§ç»‘å®š"]
    
    C --> C1["é¿å…é¢‘ç¹å†…å­˜åˆ†é…"]
    C --> C2["ä½¿ç”¨å†…å­˜æ± "]
    C --> C3["åˆ©ç”¨CMAåˆ†é…å¤§å—è¿ç»­å†…å­˜"]
    
    D --> D1["ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ"]
    D --> D2["ä¼˜åŒ–çº¹ç†å‹ç¼©"]
    D --> D3["å‡å°‘çŠ¶æ€åˆ‡æ¢"]
    
    E["å·¥å…·"] --> F["perf: æ€§èƒ½åˆ†æ"]
    E --> G["top/htop: CPUç›‘æ§"]
    E --> H["vmstat: å†…å­˜ç›‘æ§"]
    E --> I[" Mali Profiler: GPUåˆ†æ"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
    style D fill:#f39c12
    style E fill:#9b59b6
```

**ä¼˜åŒ–å»ºè®®ï¼š**
1. **CPUè°ƒåº¦**ï¼šåˆç†ä½¿ç”¨å¤§å°æ ¸ï¼Œè®¡ç®—å¯†é›†ä»»åŠ¡åˆ†é…åˆ°å¤§æ ¸
2. **å†…å­˜ç®¡ç†**ï¼šé¿å…é¢‘ç¹åˆ†é…ï¼Œä½¿ç”¨å†…å­˜æ± å’ŒCMA
3. **GPUä¼˜åŒ–**ï¼šåˆ©ç”¨ç¡¬ä»¶åŠ é€Ÿï¼Œä¼˜åŒ–çº¹ç†å‹ç¼©
4. **å·¥å…·ä½¿ç”¨**ï¼šperfã€vmstatã€Mali Profiler

##### 8.0.8.11 æ€»ç»“

```mermaid
mindmap
  root((MT8676))
    åŸºæœ¬ä¿¡æ¯
      è”å‘ç§‘è½¦æœºèŠ¯ç‰‡
      6nmåˆ¶ç¨‹
      8æ ¸ARMæ¶æ„
    CPUé…ç½®
      4x Cortex-A78 å¤§æ ¸
      4x Cortex-A55 å°æ ¸
      æœ€é«˜2.2GHz
    å†…å­˜
      LPDDR4X
      æœ€é«˜8GB
      å•èŠ‚ç‚¹éNUMA
    GPU
      Mali-G57 MC5
      4K@60fps
      å¤šå±æ˜¾ç¤º
    åº”ç”¨
      è½¦è½½å¨±ä¹
      å¯¼èˆªç³»ç»Ÿ
      è¯­éŸ³åŠ©æ‰‹
    ç‰¹ç‚¹
      ä½åŠŸè€—
      é«˜æ€§èƒ½
      æˆç†Ÿæ–¹æ¡ˆ
```

**MT8676æ ¸å¿ƒç‰¹ç‚¹ï¼š**

- âœ… **1ä¸ªSoCèŠ¯ç‰‡**ï¼Œé›†æˆ8ä¸ªCPUæ ¸å¿ƒ
- âœ… **å¼‚æ„æ¶æ„**ï¼š4å¤§æ ¸ï¼ˆA78ï¼‰+ 4å°æ ¸ï¼ˆA55ï¼‰
- âœ… **å•èŠ‚ç‚¹è®¾è®¡**ï¼šæ— NUMAè·¨èŠ‚ç‚¹é—®é¢˜
- âœ… **ç»Ÿä¸€å†…å­˜**ï¼šCPU/GPUå…±äº«ç‰©ç†å†…å­˜
- âœ… **è½¦æœºä¸“ç”¨**ï¼šé’ˆå¯¹æ™ºèƒ½åº§èˆ±ä¼˜åŒ–

**é€‚åˆä½ çš„å·¥ä½œï¼š**

- è½¦è½½å¨±ä¹ç³»ç»Ÿå¼€å‘
- å¯¼èˆªåº”ç”¨å¼€å‘
- è¯­éŸ³åŠ©æ‰‹å¼€å‘
- å¤šå±æ˜¾ç¤ºåº”ç”¨
- AIåº”ç”¨ï¼ˆé©¾é©¶å‘˜ç›‘æµ‹ç­‰ï¼‰

### 8.1 ä»€ä¹ˆæ˜¯NUMAå’ŒNodeï¼Ÿ

#### 8.1.1 åŸºæœ¬æ¦‚å¿µ

```mermaid
graph TB
    A[NUMAæ¦‚å¿µ] --> B[Node èŠ‚ç‚¹]
    A --> C[æœ¬åœ°å†…å­˜]
    A --> D[è¿œç¨‹å†…å­˜]
    
    B --> B1["CPU + å†…å­˜ç»„åˆ"]
    B --> B2["ç‹¬ç«‹çš„NUMAèŠ‚ç‚¹"]
    B --> B3["é€šè¿‡é«˜é€Ÿæ€»çº¿è¿æ¥"]
    
    C --> C1["Nodeæœ¬åœ°çš„å†…å­˜"]
    C --> C2["è®¿é—®é€Ÿåº¦å¿«"]
    C --> C3["~60nså»¶è¿Ÿ"]
    
    D --> D1["å…¶ä»–Nodeçš„å†…å­˜"]
    D --> D2["è®¿é—®é€Ÿåº¦æ…¢"]
    D --> D3["~120-150nså»¶è¿Ÿ"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
    style D fill:#f39c12
```

**ç®€å•ç†è§£ï¼š**

- **NUMAï¼ˆNon-Uniform Memory Accessï¼‰**ï¼šéç»Ÿä¸€å†…å­˜è®¿é—®
- **Nodeï¼ˆèŠ‚ç‚¹ï¼‰**ï¼šä¸€ä¸ªCPUï¼ˆæˆ–å¤šä¸ªCPUï¼‰+ å®ƒçš„æœ¬åœ°å†…å­˜çš„ç»„åˆ
- **æœ¬åœ°å†…å­˜**ï¼šæœ¬èŠ‚ç‚¹ä¸Šçš„å†…å­˜ï¼Œè®¿é—®å¿«
- **è¿œç¨‹å†…å­˜**ï¼šå…¶ä»–èŠ‚ç‚¹çš„å†…å­˜ï¼Œè®¿é—®æ…¢ï¼ˆéœ€è¦é€šè¿‡æ€»çº¿ï¼‰

#### 8.1.2 å®ä¾‹å¯¹æ¯”ï¼šä¸¤ç§8æ ¸CPUé…ç½®

##### é…ç½®1ï¼š8æ ¸ï¼ˆ4å¤§æ ¸ + 4å°æ ¸ï¼‰- åŒNode NUMA

```mermaid
graph TB
    A["8æ ¸å¤„ç†å™¨: 4å¤§æ ¸+4å°æ ¸"] --> B[Node 0]
    A --> C[Node 1]
    
    B --> B1["å¤§æ ¸ x4"]
    B1 --> B2["æ€§èƒ½æ ¸ P-Core"]
    B1 --> B3["CPU0-3"]
    B --> B4["æœ¬åœ°å†…å­˜ 8GB"]
    B --> B5["è®¿é—®é€Ÿåº¦: å¿«"]
    
    C --> C1["å°æ ¸ x4"]
    C1 --> C2["èƒ½æ•ˆæ ¸ E-Core"]
    C1 --> C3["CPU4-7"]
    C --> C4["æœ¬åœ°å†…å­˜ 8GB"]
    C --> C5["è®¿é—®é€Ÿåº¦: å¿«"]
    
    B4 --> D["é«˜é€Ÿæ€»çº¿ QPI/Infinity Fabric"]
    C4 --> D
    
    D --> E["è·¨èŠ‚ç‚¹è®¿é—®: æ…¢"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#f39c12
    style D fill:#9b59b6
    style E fill:#e67e22
```

**ç‰¹ç‚¹ï¼š**
- **Node 0**ï¼š4ä¸ªæ€§èƒ½æ ¸ï¼ˆå¤§æ ¸ï¼‰+ 8GBæœ¬åœ°å†…å­˜
- **Node 1**ï¼š4ä¸ªèƒ½æ•ˆæ ¸ï¼ˆå°æ ¸ï¼‰+ 8GBæœ¬åœ°å†…å­˜
- **æœ¬åœ°è®¿é—®**ï¼šCPUè®¿é—®è‡ªå·±èŠ‚ç‚¹çš„å†…å­˜ï¼Œé€Ÿåº¦å¿«
- **è¿œç¨‹è®¿é—®**ï¼šCPUè®¿é—®å¦ä¸€ä¸ªèŠ‚ç‚¹çš„å†…å­˜ï¼Œé€Ÿåº¦æ…¢

**é€‚ç”¨åœºæ™¯ï¼š**
- æ··åˆè´Ÿè½½ï¼šå¤§æ ¸å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œå°æ ¸å¤„ç†åå°ä»»åŠ¡
- ç§»åŠ¨è®¾å¤‡ï¼šå¹³è¡¡æ€§èƒ½å’ŒåŠŸè€—
- æ¡Œé¢åº”ç”¨ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹è°ƒåº¦åˆ°ä¸åŒæ ¸å¿ƒ

##### é…ç½®2ï¼š8æ ¸ï¼ˆå…¨å¤§æ ¸ï¼‰- åŒNode NUMA

```mermaid
graph TB
    A["8æ ¸å¤„ç†å™¨: å…¨å¤§æ ¸"] --> B[Node 0]
    A --> C[Node 1]
    
    B --> B1["å¤§æ ¸ x4"]
    B1 --> B2["æ€§èƒ½æ ¸ P-Core"]
    B1 --> B3["CPU0-3"]
    B --> B4["æœ¬åœ°å†…å­˜ 8GB"]
    B --> B5["è®¿é—®é€Ÿåº¦: å¿«"]
    
    C --> C6["å¤§æ ¸ x4"]
    C6 --> C7["æ€§èƒ½æ ¸ P-Core"]
    C6 --> C8["CPU4-7"]
    C --> C9["æœ¬åœ°å†…å­˜ 8GB"]
    C --> C10["è®¿é—®é€Ÿåº¦: å¿«"]
    
    B4 --> D["é«˜é€Ÿæ€»çº¿ QPI/Infinity Fabric"]
    C9 --> D
    
    D --> E["è·¨èŠ‚ç‚¹è®¿é—®: æ…¢"]
    
    F[æ€§èƒ½å¯¹æ¯”] --> G["æœ¬åœ°è®¿é—®: ~60ns"]
    F --> H["è¿œç¨‹è®¿é—®: ~120-150ns"]
    F --> I["æ…¢çº¦2-3å€"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#3498db
    style D fill:#9b59b6
    style E fill:#e67e22
    style F fill:#2ecc71
```

**ç‰¹ç‚¹ï¼š**
- **Node 0**ï¼š4ä¸ªæ€§èƒ½æ ¸ + 8GBæœ¬åœ°å†…å­˜
- **Node 1**ï¼š4ä¸ªæ€§èƒ½æ ¸ + 8GBæœ¬åœ°å†…å­˜
- **å¯¹ç§°è®¾è®¡**ï¼šä¸¤ä¸ªNodeå®Œå…¨ç›¸åŒ
- **æ€§èƒ½ä¸€è‡´**ï¼šæ‰€æœ‰æ ¸å¿ƒæ€§èƒ½ç›¸åŒ

**é€‚ç”¨åœºæ™¯ï¼š**
- é«˜æ€§èƒ½è®¡ç®—ï¼ˆHPCï¼‰
- æ•°æ®åº“æœåŠ¡å™¨
- è™šæ‹ŸåŒ–ç¯å¢ƒ
- éœ€è¦å‡åŒ€æ€§èƒ½çš„åº”ç”¨

#### 8.1.3 ä¸¤ç§é…ç½®å¯¹æ¯”

```mermaid
graph TB
    A["8æ ¸CPUé…ç½®å¯¹æ¯”"] --> B["é…ç½®1: 4å¤§+4å°"]
    A --> C["é…ç½®2: 8å¤§æ ¸"]
    
    B --> B1["Node 0: 4å¤§æ ¸ + 8GB"]
    B --> B2["Node 1: 4å°æ ¸ + 8GB"]
    B --> B3["å¼‚æ„æ ¸å¿ƒ"]
    B --> B4["æ€§èƒ½ä¸å‡è¡¡"]
    B --> B5["é€‚åˆæ··åˆè´Ÿè½½"]
    
    C --> C1["Node 0: 4å¤§æ ¸ + 8GB"]
    C --> C2["Node 1: 4å¤§æ ¸ + 8GB"]
    C --> C3["åŒæ„æ ¸å¿ƒ"]
    C --> C4["æ€§èƒ½å‡è¡¡"]
    C --> C5["é€‚åˆé«˜æ€§èƒ½è®¡ç®—"]
    
    D[å…±åŒç‚¹] --> E["éƒ½æ˜¯NUMAæ¶æ„"]
    D --> F["éƒ½æœ‰2ä¸ªNode"]
    D --> G["æ¯Nodeæœ‰ç‹¬ç«‹å†…å­˜"]
    D --> H["è·¨èŠ‚ç‚¹è®¿é—®æ…¢"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#f39c12
    style D fill:#2ecc71
```

| å¯¹æ¯”é¡¹ | é…ç½®1ï¼ˆ4å¤§+4å°ï¼‰ | é…ç½®2ï¼ˆ8å¤§æ ¸ï¼‰ |
|--------|------------------|----------------|
| **æ ¸å¿ƒç±»å‹** | å¼‚æ„ï¼ˆå¤§æ ¸+å°æ ¸ï¼‰ | åŒæ„ï¼ˆå…¨å¤§æ ¸ï¼‰ |
| **Node 0** | 4å¤§æ ¸ + 8GB | 4å¤§æ ¸ + 8GB |
| **Node 1** | 4å°æ ¸ + 8GB | 4å¤§æ ¸ + 8GB |
| **æ€§èƒ½ç‰¹ç‚¹** | æ€§èƒ½ä¸å‡è¡¡ | æ€§èƒ½å‡è¡¡ |
| **é€‚ç”¨åœºæ™¯** | æ··åˆè´Ÿè½½ã€ç§»åŠ¨è®¾å¤‡ | é«˜æ€§èƒ½è®¡ç®—ã€æœåŠ¡å™¨ |
| **åŠŸè€—** | è¾ƒä½ï¼ˆå°æ ¸çœç”µï¼‰ | è¾ƒé«˜ |
| **NUMAä¼˜åŒ–** | éœ€è¦åŒºåˆ†å¤§å°æ ¸ | å¯¹ç§°ä¼˜åŒ–æ›´ç®€å• |

#### 8.1.4 NUMAè®¿é—®å»¶è¿Ÿ

```mermaid
graph LR
    A[CPU0åœ¨Node0] --> B[è®¿é—®Node0å†…å­˜]
    A --> C[è®¿é—®Node1å†…å­˜]
    
    B --> D["æœ¬åœ°è®¿é—® ~60ns"]
    C --> E["è¿œç¨‹è®¿é—® ~120-150ns"]
    
    E --> F["æ…¢2-3å€"]
    
    style A fill:#3498db
    style B fill:#2ecc71
    style C fill:#e67e22
    style D fill:#2ecc71
    style E fill:#e67e22
```

**å…³é”®ç‚¹ï¼š**
- æœ¬åœ°è®¿é—®ï¼šCPUè®¿é—®è‡ªå·±Nodeçš„å†…å­˜ï¼Œçº¦60ns
- è¿œç¨‹è®¿é—®ï¼šCPUè®¿é—®å…¶ä»–Nodeçš„å†…å­˜ï¼Œçº¦120-150ns
- å»¶è¿Ÿå·®å¼‚ï¼šè¿œç¨‹è®¿é—®æ¯”æœ¬åœ°è®¿é—®æ…¢2-3å€

#### 8.1.5 ä¸ºä»€ä¹ˆéœ€è¦NUMAï¼Ÿ

```mermaid
mindmap
  root((NUMAéœ€æ±‚))
    æ€§èƒ½é—®é¢˜
      UMAç“¶é¢ˆ
      å•ä¸€å†…å­˜æ§åˆ¶å™¨
      å†…å­˜å¸¦å®½é™åˆ¶
    è§£å†³æ–¹æ¡ˆ
      å¤šä¸ªå†…å­˜æ§åˆ¶å™¨
      å°±è¿‘è®¿é—®å†…å­˜
      æé«˜å¸¦å®½åˆ©ç”¨ç‡
    åº”ç”¨åœºæ™¯
      å¤šæ ¸æœåŠ¡å™¨
      é«˜æ€§èƒ½è®¡ç®—
      å¤§å‹æ•°æ®åº“
    ä¼˜åŠ¿
      æ‰©å±•æ€§å¥½
      å¸¦å®½é«˜
      å»¶è¿Ÿä½
```

### 8.2 NUMAåŸºç¡€

### 8.2 NUMAå†…å­˜åˆ†é…ç­–ç•¥

```mermaid
graph TB
    A[åˆ†é…ç­–ç•¥] --> B[æœ¬åœ°åˆ†é…ä¼˜å…ˆ]
    A --> C[äº¤é”™åˆ†é…]
    A --> D[ç»‘å®šåˆ†é…]
    A --> E[é¦–é€‰èŠ‚ç‚¹]
    
    B --> B1["CPUä»æœ¬åœ°èŠ‚ç‚¹åˆ†é…"]
    B --> B2["å‡å°‘è·¨èŠ‚ç‚¹è®¿é—®"]
    
    C --> C1["èŠ‚ç‚¹é—´è½®è¯¢åˆ†é…"]
    C --> C2["å‡è¡¡å„èŠ‚ç‚¹ä½¿ç”¨"]
    
    D --> D1["å¼ºåˆ¶æŒ‡å®šèŠ‚ç‚¹"]
    D --> D2["ç¡®ä¿ç¡®å®šæ€§"]
    
    E --> E1["ä¼˜å…ˆæŒ‡å®šèŠ‚ç‚¹"]
    E --> E2["ä¸è¶³æ—¶ä»å…¶ä»–èŠ‚ç‚¹"]
    
    style A fill:#e74c3c
    style B fill:#2ecc71
```

---

## ä¹ã€å†…å­˜è°ƒè¯•ä¸æ€§èƒ½åˆ†æ

### 9.1 å†…å­˜è°ƒè¯•å·¥å…·

```mermaid
graph TB
    A[è°ƒè¯•å·¥å…·] --> B[Valgrind]
    A --> C[AddressSanitizer]
    A --> D[GDB]
    A --> E[eBPF]
    
    B --> B1[Memcheck]
    B --> B2[Massif]
    B --> B3[Cachegrind]
    
    C --> C1["ç¼–è¯‘æ—¶æ’æ¡©"]
    C --> C2["å¼€é”€å° 2x-5x"]
    
    D --> D1["æŸ¥çœ‹æ ˆå†…å­˜"]
    D --> D2["ç›‘æ§å†…å­˜å˜åŒ–"]
    
    E --> E1["åŠ¨æ€è·Ÿè¸ª"]
    E --> E2["å®æ—¶åˆ†æ"]
    
    style A fill:#e74c3c
    style B fill:#3498db
    style C fill:#2ecc71
```

### 9.2 æ€§èƒ½ç›‘æ§

```mermaid
graph TB
    A[ç›‘æ§å·¥å…·] --> B[free]
    A --> C[vmstat]
    A --> D[top/htop]
    A --> E[slabtop]
    A --> F[smem]
    
    B --> B1["å†…å­˜ä½¿ç”¨æƒ…å†µ"]
    
    C --> C1["è™šæ‹Ÿå†…å­˜ç»Ÿè®¡"]
    C --> C2["Swap in/out"]
    
    D --> D1["å®æ—¶è¿›ç¨‹ç›‘æ§"]
    
    E --> E1["Slabç¼“å­˜ç›‘æ§"]
    
    F --> F1["è¯¦ç»†å†…å­˜åˆ†æ"]
    F --> F2["PSSç»Ÿè®¡"]
    
    G[å†…æ ¸æ¥å£] --> H["/proc/meminfo"]
    G --> I["/proc/pid/smaps"]
    G --> J["/proc/pid/maps"]
    G --> K["/sys/kernel/mm/"]
    
    style A fill:#e74c3c
    style G fill:#f39c12
```

---

## åã€å­¦ä¹ è·¯å¾„è§„åˆ’

### 10.1 å­¦ä¹ é˜¶æ®µ

```mermaid
timeline
    title Linuxå†…å­˜ç®¡ç†å­¦ä¹ è·¯å¾„
    section åŸºç¡€é˜¶æ®µ (1-2å‘¨)
        ç†è®ºå­¦ä¹  : å†…å­˜ç®¡ç†åŸºæœ¬æ¦‚å¿µ<br>Linux 6.xæ¶æ„
        å®è·µæ“ä½œ : free/vmstatå‘½ä»¤<br>/procæ–‡ä»¶ç³»ç»Ÿ
    section è¿›é˜¶é˜¶æ®µ (2-3å‘¨)
        æ·±å…¥å­¦ä¹  : é¡µé¢ç®¡ç†æœºåˆ¶<br>å†…å­˜åˆ†é…ç®—æ³•
        ç¼–ç¨‹å®è·µ : å†…å­˜åˆ†é…æµ‹è¯•<br>mmapæ–‡ä»¶æ˜ å°„
    section é«˜çº§é˜¶æ®µ (3-4å‘¨)
        é«˜çº§ç‰¹æ€§ : NUMAæ¶æ„<br>å†…å­˜å‹ç¼©æŠ€æœ¯
        æ€§èƒ½è°ƒä¼˜ : perfåˆ†æ<br>å‚æ•°è°ƒä¼˜
    section å®æˆ˜é˜¶æ®µ (æŒç»­)
        é¡¹ç›®å®è·µ : å†…æ ¸æ¨¡å—å¼€å‘<br>æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹
        æŒç»­å­¦ä¹  : è·Ÿè¸ªå†…æ ¸æ›´æ–°<br>é˜…è¯»å†…æ ¸æ–‡æ¡£
```

### 10.2 å­¦ä¹ èµ„æº

```mermaid
mindmap
  root((å­¦ä¹ èµ„æº))
    ä¹¦ç±
      å›¾è§£Linuxå†…æ ¸ åŸºäº6.x
      æ·±å…¥ç†è§£Linuxå†…æ ¸
      Linuxå†…æ ¸è®¾è®¡ä¸å®ç°
    åœ¨çº¿èµ„æº
      Linuxå†…æ ¸å®˜æ–¹æ–‡æ¡£
      LWN.netæ–‡ç« 
      Kernel.orgé‚®ä»¶åˆ—è¡¨
    æºç èµ„æº
      Linuxå†…æ ¸æºç 
      å†…æ ¸ä»£ç æµè§ˆå™¨
      Linux Cross Reference
    å®éªŒç¯å¢ƒ
      Linuxè™šæ‹Ÿæœº
      å†…æ ¸æºç ç¼–è¯‘
      è°ƒè¯•å·¥å…·å®‰è£…
```

---

## åä¸€ã€å®æˆ˜æ¡ˆä¾‹

### 11.1 å†…å­˜æ³„æ¼æ£€æµ‹

```c
// ä½¿ç”¨Valgrindæ£€æµ‹å†…å­˜æ³„æ¼
// ç¼–è¯‘: gcc -g program.c -o program
// è¿è¡Œ: valgrind --leak-check=full --show-leak-kinds=all ./program

#include <stdlib.h>
#include <stdio.h>

void memory_leak_example() {
    // æ•…æ„åˆ¶é€ å†…å­˜æ³„æ¼
    char *ptr1 = malloc(100);
    char *ptr2 = malloc(200);
    
    // åªé‡Šæ”¾ptr1ï¼Œptr2æ³„æ¼
    free(ptr1);
    
    printf("Memory leak example\n");
}

int main() {
    memory_leak_example();
    return 0;
}
```

### 11.2 ä½¿ç”¨mmapè¿›è¡Œæ–‡ä»¶æ˜ å°„

```c
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>

int main() {
    int fd;
    char *mapped;
    struct stat sb;
    
    // æ‰“å¼€æ–‡ä»¶
    fd = open("test.txt", O_RDWR);
    if (fd == -1) {
        perror("open");
        return 1;
    }
    
    // è·å–æ–‡ä»¶å¤§å°
    if (fstat(fd, &sb) == -1) {
        perror("fstat");
        close(fd);
        return 1;
    }
    
    // æ˜ å°„æ–‡ä»¶åˆ°å†…å­˜
    mapped = mmap(NULL, sb.st_size, PROT_READ | PROT_WRITE,
                  MAP_SHARED, fd, 0);
    if (mapped == MAP_FAILED) {
        perror("mmap");
        close(fd);
        return 1;
    }
    
    // è¯»å†™æ˜ å°„çš„å†…å­˜
    printf("File content: %s\n", mapped);
    mapped[0] = 'H';  // ä¿®æ”¹æ–‡ä»¶
    
    // è§£é™¤æ˜ å°„
    if (munmap(mapped, sb.st_size) == -1) {
        perror("munmap");
    }
    
    close(fd);
    return 0;
}
```

### 11.3 NUMAä¼˜åŒ–ç¤ºä¾‹

```bash
# æŸ¥çœ‹NUMAæ‹“æ‰‘
numactl --hardware

# åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šè¿è¡Œç¨‹åº
numactl --cpunodebind=0 --membind=0 ./program

# äº¤é”™åˆ†é…å†…å­˜
numactl --interleave=all ./program

# æŸ¥çœ‹è¿›ç¨‹NUMAç­–ç•¥
numactl --show

# è¿ç§»è¿›ç¨‹å†…å­˜
migratepages <pid> <from_node> <to_node>
```

---

## åäºŒã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 12.1 å†…å­˜é—®é¢˜è¯Šæ–­æµç¨‹

```mermaid
flowchart TD
    A[å‘ç°å†…å­˜é—®é¢˜] --> B{é—®é¢˜ç±»å‹}
    
    B --> C[å†…å­˜æ³„æ¼]
    B --> D[å†…å­˜ä¸è¶³]
    B --> E[æ€§èƒ½å·®]
    
    C --> C1[Valgrind/ASanæ£€æµ‹]
    C1 --> C2[å®šä½æ³„æ¼ä»£ç ]
    C2 --> C3[ä¿®å¤ä»£ç ]
    
    D --> D1[æŸ¥çœ‹å†…å­˜ä½¿ç”¨]
    D1 --> D2[æ£€æŸ¥Swap]
    D2 --> D3[ä¼˜åŒ–å†…å­˜åˆ†é…]
    
    E --> E1[perfåˆ†æ]
    E1 --> E2[æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡]
    E2 --> E3[ä¼˜åŒ–è®¿é—®æ¨¡å¼]
    
    style A fill:#e74c3c
    style C fill:#3498db
    style D fill:#f39c12
    style E fill:#2ecc71
```

### 12.2 å¸¸ç”¨è°ƒä¼˜å‚æ•°

```bash
# Swapä½¿ç”¨å€¾å‘ (0-100)
echo 10 > /proc/sys/vm/swappiness

# æœ€å°ç©ºé—²å†…å­˜
echo 65536 > /proc/sys/vm/min_free_kbytes

# å¯ç”¨å¤§é¡µ
echo 100 > /proc/sys/vm/nr_hugepages

# å¯ç”¨KSM
echo 1 > /sys/kernel/mm/ksm/run

# è°ƒæ•´è„é¡µå›å†™
echo 5 > /proc/sys/vm/dirty_background_ratio
echo 10 > /proc/sys/vm/dirty_ratio

# æ°¸ä¹…ç”Ÿæ•ˆ
echo "vm.swappiness=10" >> /etc/sysctl.conf
sysctl -p
```

---

## åä¸‰ã€Linux 6.xæ–°ç‰¹æ€§

### 13.1 æ–°ç‰¹æ€§æ¦‚è§ˆ

```mermaid
mindmap
  root((Linux 6.xæ–°ç‰¹æ€§))
    Slubåˆ†é…å™¨æ”¹è¿›
      æ€§èƒ½æå‡
      å†…å­˜å¼€é”€å‡å°‘
      NUMAæ”¯æŒå¢å¼º
    Transparent Huge Pages
      é»˜è®¤å¯ç”¨
      è‡ªåŠ¨ç®¡ç†
      å‡å°‘TLBç¼ºå¤±
    å†…å­˜å›æ”¶ä¼˜åŒ–
      æ™ºèƒ½LRUç®—æ³•
      æ›´å¥½é¡µé¢åˆ†ç±»
      å‡å°‘å›æ”¶å¼€é”€
    NUMAä¼˜åŒ–
      è‡ªåŠ¨å†…å­˜è¿ç§»
      æ›´å¥½æœ¬åœ°æ€§
      æ”¹è¿›è´Ÿè½½å‡è¡¡
    å†…å­˜å‹ç¼©å¢å¼º
      zRAM/zSwapæ”¹è¿›
      æ›´å¥½å‹ç¼©ç®—æ³•
      æ›´ä½CPUå¼€é”€
    eBPFæ”¯æŒ
      åŠ¨æ€å†…å­˜è·Ÿè¸ª
      å®æ—¶æ€§èƒ½åˆ†æ
      çµæ´»ç›‘æ§
```

---

## é™„å½•

### A. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# å†…å­˜ä½¿ç”¨
free -h
vmstat 1 5
top -p <pid>
htop

# è¿›ç¨‹å†…å­˜
cat /proc/<pid>/maps
cat /proc/<pid>/smaps
cat /proc/<pid>/statm

# Slabç¼“å­˜
slabtop
cat /proc/slabinfo

# Swap
swapon -s
swapoff /swapfile

# NUMA
numactl --hardware
numastat
lscpu

# è°ƒè¯•
valgrind --leak-check=full ./program
perf stat -e page-faults ./program
strace -e trace=mmap,brk ./program
```

### B. å†…æ ¸å‚æ•°é…ç½®

```bash
# /etc/sysctl.conf
vm.swappiness = 10
vm.min_free_kbytes = 65536
vm.vfs_cache_pressure = 50
vm.dirty_ratio = 10
vm.dirty_background_ratio = 5
vm.overcommit_memory = 1
vm.overcommit_ratio = 50

# åº”ç”¨é…ç½®
sysctl -p
```

### C. å‚è€ƒèµ„æº

- **å†…æ ¸æ–‡æ¡£**: https://www.kernel.org/doc/html/latest/
- **å†…æ ¸æºç **: https://github.com/torvalds/linux
- **ä»£ç æµè§ˆ**: https://elixir.bootlin.com/
- **LWN**: https://lwn.net/

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2026å¹´1æœˆ18æ—¥
**åŸºäºå†…æ ¸ç‰ˆæœ¬**: Linux 6.x

**ç¥ä½ å­¦ä¹ é¡ºåˆ©ï¼ğŸ‰**